<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Preparação elétrica</title>
  <!-- Font Awesome para os ícones das fotos -->
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
  <!-- Seu CSS principal -->
  <link rel="stylesheet" href="menu_produto.css"/>
<style>
/* ——— QR modal ——— */
#qrModal{position:fixed;inset:0;display:none;background:rgba(0,0,0,.5);z-index:2000;align-items:center;justify-content:center;padding:24px}
#qrModal.open{display:flex}
.qr-box{width:min(640px,100%);background:var(--header-bg,#111);color:var(--text,#fff);border-radius:16px;box-shadow:0 12px 24px rgba(0,0,0,.35);padding:16px}
.qr-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.qr-close{appearance:none;border:0;background:transparent;font-size:26px;line-height:1;cursor:pointer;color:inherit}
#qrModal .modal-content{width:min(580px,92vw);max-height:90vh}
#qrReader{width:100%;height:60vh;max-height:75vh;background:#000}
#qrReader video{width:100%!important;height:100%!important;object-fit:cover;filter:brightness(1.15) contrast(1.08)}

/* ——— Layout compartilhado (Produto & Gestão) ——— */
#produtoTab .produto-layout,#gestaoTab .produto-layout{display:flex;gap:16px;align-items:flex-start}
#produtoTab .mini-board{flex:1;min-width:0}
#produtoTab .side-actions,#gestaoTab .side-actions{position:relative;width:220px;flex:0 0 220px;display:flex;align-items:flex-start}

/* ——— Botões ——— */
.btn-stack{display:flex;flex-direction:column;gap:10px;width:100%}
.btn-modern{appearance:none;border:0;width:100%;padding:14px 18px;border-radius:16px;font-weight:600;letter-spacing:.2px;cursor:pointer;color:#fff;background:linear-gradient(135deg,#4f46e5,#22d3ee);box-shadow:0 12px 22px rgba(79,70,229,.22),0 6px 10px rgba(34,211,238,.18);transition:transform .12s ease,box-shadow .2s ease,filter .2s ease}
.btn-modern:hover{transform:translateY(-1px);box-shadow:0 16px 26px rgba(79,70,229,.28),0 10px 14px rgba(34,211,238,.22)}
.btn-modern:active{transform:translateY(0);filter:brightness(.96)}
.btn-modern.btn-ghost{background:transparent;color:#4f46e5;box-shadow:inset 0 0 0 2px rgba(79,70,229,.45)}
.btn-modern.btn-ghost:hover{transform:none;filter:none;box-shadow:inset 0 0 0 2px rgba(79,70,229,.65),0 2px 6px rgba(0,0,0,.06)}
.btn-modern.btn-success{background:linear-gradient(135deg,#16a34a,#22c55e);box-shadow:0 12px 22px rgba(22,163,74,.22),0 6px 10px rgba(34,197,94,.18)}
.btn-modern.btn-success:hover{transform:translateY(-1px);box-shadow:0 16px 26px rgba(22,163,74,.28),0 10px 14px rgba(34,197,94,.22)}

/* ——— SQL menu (Produto & Gestão) ——— */
#produtoTab .sql-menu,#gestaoTab .sql-menu{position:absolute;right:0;top:calc(100% + 8px);background:var(--header-bg,#111);color:var(--text,#fff);border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.25);padding:8px;min-width:220px;display:none;z-index:3000}
#produtoTab .sql-menu.open,#gestaoTab .sql-menu.open{display:block}
#produtoTab .sql-menu button,#gestaoTab .sql-menu button{width:100%;appearance:none;border:0;background:transparent;text-align:left;padding:10px 12px;cursor:pointer;border-radius:10px;color:inherit}
#produtoTab .sql-menu button:hover,#gestaoTab .sql-menu button:hover{background:rgba(255,255,255,.08)}

/* ——— Responsivo ——— */
@media (max-width:1100px){
  #produtoTab .produto-layout,#gestaoTab .produto-layout{flex-direction:column}
  #produtoTab .side-actions,#gestaoTab .side-actions{width:100%;flex:0 0 auto}
}

/* ——— Largura exclusiva desta página (3 colunas) ——— */
#paginaPrepEletrica .kanban-board:not(.mini-board){display:grid!important;grid-template-columns:repeat(3,minmax(300px,1fr));gap:20px;max-width:none!important}
#paginaPrepEletrica .kanban-board:not(.mini-board) .kanban-column{width:auto!important;max-width:none!important;flex:0 0 auto!important}

/* Mini-board (aba Produto) 2 colunas confortáveis */
#paginaPrepEletrica .kanban-board.mini-board{display:grid!important;grid-template-columns:repeat(2,minmax(320px,1fr));gap:16px}
</style>


</head>
<body>


  <div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
    </svg>
  </div>

  <div class="app">
    <!-- Cabeçalho principal -->
<!-- ===== CABEÇALHO PRINCIPAL ===== -->
<div class="header" id="appHeader">
  <img class="menu-logo" src="../img/logo.png" alt="Logo da empresa" />

  <!-- Links que podem “sobrar” -->
  <nav id="mainMenu" class="header-menu">
    

 <a id="menu-inicio"
    class="menu-link is-active"
    data-target="paginaInicio">Início</a>
    <a id="menu-produto" class="menu-link" href="#" data-target="produtoTab">Produto</a>
    <a id="menu-qualidade"     class="menu-link" href="#">Qualidade</a>
    <a id="menu-gestao" class="menu-link" href="#">Gestão</a>
    <a id="menu-notificacoes"  class="menu-link" href="#">Notificações</a>
  </nav>

  <!-- Botão …  (fica invisível até o JS precisar dele) -->
<button id="moreBtn" class="more-btn" aria-label="Mais opções">
  <!-- era: <i class="fa-solid fa-ellipsis-h"></i> -->
  <i class="fa-solid fa-ellipsis"></i>
</button>

  <!-- Campo de busca -->
  <div class="search-bar" id="searchBar">
    <input type="text" placeholder="Pesquisar produto" />
  </div>

  <!-- Ícones da direita -->
  <div class="header-profile">
    <div class="notification">
      <span class="notification-number">5</span>
      <i class="fa-solid fa-bell"></i>
    </div>
    <i class="fa-solid fa-print"></i>
    <i class="fa-solid fa-cloud"></i>
    <img id="profile-icon" class="profile-img"
         src="https://images.unsplash.com/photo-1600353068440-6361ef3a86e8?auto=format&fit=crop&w=1000&q=80"
         alt="Perfil">
  </div>

  <!-- Dropdown criado dinamicamente -->
  <div id="moreMenu" class="more-menu"></div>
</div>



    <div class="wrapper">

      <!-- ===== MENU LATERAL ===== -->
<div class="left-side">
  <div class="side-wrapper">
    <div class="side-title">Aqui será a NIQ</div>

    <div class="side-menu">
      <!-- coloque links ou deixe vazio por enquanto -->
      <a href="#" class="menu-link">Item a ser verificado 01</a>
      <a href="#" class="menu-link">Item a ser verificado 02</a>
    </div>
  </div>
</div>


      <!-- Conteúdo principal -->

      <!-- Painel Início — aparece primeiro -->
<!-- Painel Preparação elétrica -->
<div id="paginaPrepEletrica" class="tab-pane" style="display:block;">


  
  <!-- === bloco PREPARAÇÃO (Kanban) ============================ -->
<div id="conteudo-preparacao" class="kanban-page" >
  <div class="kanban-board">

    <!-- 🟦 Coluna 1: Fila de produção -->
    <div class="kanban-column">
<div class="kanban-header">
  <div class="title-wrapper"><span>A Produzir</span></div>
  <i class="fas fa-plus add-btn" style="display:none"></i>
  <div class="add-container" style="display:none"></div>
</div>

      <ul id="coluna-prep-fila" class="kanban-list"></ul>
    </div>

    <!-- 🟦 Coluna 2: Em produção -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>Em produção</span>
      </div>
      <ul id="coluna-prep-em-producao" class="kanban-list"></ul>
    </div>

    <!-- 🟦 Coluna 3: Concluído -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>Concluído</span>
      </div>
      <ul id="coluna-prep-concluido" class="kanban-list"></ul>
    </div>

  </div><!-- /.kanban-board -->
</div>
<!-- ========================================================= -->
</div>



<!-- Guia Produto -->
<div id="produtoTab" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="title-wrapper">
      <div class="content-section-title">
        Produto  <span id="produtoSelecionado"></span>
      </div>
    </div>

<!-- layout lado-a-lado: kanban (esq) + botão (dir) -->
<div class="produto-layout">
  <div class="kanban-board mini-board">
    <div class="kanban-column">
      <div class="kanban-header"><span>Fila de produção</span></div>
      <ul id="prod-col-fila" class="kanban-list"></ul>
    </div>

    <div class="kanban-column">
      <div class="kanban-header"><span>Em produção</span></div>
      <ul id="prod-col-emprod" class="kanban-list"></ul>
    </div>
  </div>

<div class="side-actions">
  <div class="btn-stack">
    <button id="btn-iniciar" class="btn-modern" type="button">
      Iniciar produção
    </button>

<button id="btn-finalizar" class="btn-modern btn-success" type="button">
  Finalizar produção
</button>



  </div>
</div>

</div>

  </div>
</div>

<!-- Aba Gestão (fora do #produtoTab) -->
<div id="gestaoTab" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="title-wrapper">
      <div class="content-section-title">Gestão</div>
    </div>

    <div class="produto-layout">
      <div class="side-actions">
        <div class="btn-stack">
          <button id="btn-baixar-csv-gestao" class="btn-modern" type="button">
            Baixar CSV
          </button>
          <button id="btn-sql-gestao" class="btn-modern" type="button">
            SQL
          </button>
        </div>
      </div>
    </div>
  </div>
</div>



    </div> <!-- /.wrapper -->

    <div class="overlay-app" id="authOverlay"></div>
  </div> <!-- /.app -->



<!-- Modal de etiquetas ----------------------------->
<div id="etiquetasModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h3>Etiquetas disponíveis</h3>
    <ul id="listaEtiquetas" class="etiquetas-list"></ul>
  </div>
</div>


  <!-- coloca logo antes do fechamento do body -->
<!-- coloque ANTES do seu script de inicialização -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script type="module" src="./kanban/kanban.js" defer></script>

<!-- coloca logo antes do fechamento do body -->
<script type="module">
  import { initPreparacaoKanban } from './kanban/kanban_preparacao.js';

  document.addEventListener('DOMContentLoaded', () => {
    initPreparacaoKanban();

    // ===== refs da UI
    const menuInicio   = document.getElementById('menu-inicio');
    const menuProduto  = document.getElementById('menu-produto');
    const menuGestao   = document.getElementById('menu-gestao');

    const paginaPrep   = document.getElementById('paginaPrepEletrica');
    const produtoTab   = document.getElementById('produtoTab');
    const gestaoTab    = document.getElementById('gestaoTab');

    const miniCodigoEl = document.getElementById('produtoSelecionado');
    const ulMiniFila   = document.getElementById('prod-col-fila');
    const ulMiniEmProd = document.getElementById('prod-col-emprod');

    window.codigoSelecionado = null;

    // ===== navegação das abas
    const setActive = (el) => {
      document.querySelectorAll('#mainMenu .menu-link').forEach(a => a.classList.remove('is-active'));
      el.classList.add('is-active');
    };

    menuInicio.addEventListener('click', (e) => {
      e.preventDefault();
      setActive(menuInicio);
      produtoTab.style.display = 'none';
      gestaoTab.style.display  = 'none';
      paginaPrep.style.display = 'block';
    });

    menuProduto.addEventListener('click', (e) => {
      e.preventDefault();
      setActive(menuProduto);
      paginaPrep.style.display = 'none';
      gestaoTab.style.display  = 'none';
      produtoTab.style.display = 'block';

      if (window.codigoSelecionado) {
        renderMiniKanban(window.codigoSelecionado);
      } else {
        miniCodigoEl.textContent = '';
        ulMiniFila.innerHTML     = '<li class="empty">Selecione um item na Fila de produção</li>';
        ulMiniEmProd.innerHTML   = '<li class="empty">—</li>';
      }
    });

    menuGestao.addEventListener('click', (e) => {
      e.preventDefault();
      setActive(menuGestao);
      paginaPrep.style.display = 'none';
      produtoTab.style.display = 'none';
      gestaoTab.style.display  = 'block';
    });

    // ===== botões da aba Gestão (CSV + SQL)
    const btnBaixarCsvGestao = document.getElementById('btn-baixar-csv-gestao');
    const btnSqlGestao       = document.getElementById('btn-sql-gestao');
    const sideBoxGestao      = document.querySelector('#gestaoTab .side-actions');

    const sqlMenu = document.createElement('div');
    sqlMenu.className = 'sql-menu';
    sqlMenu.innerHTML = `
      <button data-act="last100">Últimos 100</button>
      <button data-act="byop">Digite a OP…</button>
      <button data-act="today">Hoje</button>
      <button data-act="range">Entre datas…</button>
    `;
    sideBoxGestao?.appendChild(sqlMenu);

    btnSqlGestao?.addEventListener('click', (e) => {
      e.preventDefault();
      sqlMenu.classList.toggle('open');
    });
    document.addEventListener('click', (e) => {
      if (!sqlMenu.contains(e.target) && e.target !== btnSqlGestao) {
        sqlMenu.classList.remove('open');
      }
    });

    function openEventosQuery(q) {
      const csv  = confirm('Baixar CSV? (OK = CSV, Cancelar = ver JSON)');
      const base = csv ? '/api/preparacao/eventos.csv' : '/api/preparacao/eventos';
      const qs   = new URLSearchParams(q);
      const url  = `${base}?${qs.toString()}`;
      if (csv) {
        const a = document.createElement('a');
        a.href = url; a.download = 'op_eventos.csv';
        document.body.appendChild(a); a.click(); a.remove();
      } else {
        window.open(url, '_blank');
      }
    }

    sqlMenu.addEventListener('click', (e) => {
      const act = e.target?.dataset?.act;
      if (!act) return;
      sqlMenu.classList.remove('open');

      if (act === 'last100') {
        openEventosQuery({ limit: '100', order: 'desc' });
      } else if (act === 'byop') {
        const op = prompt('Digite a OP (ex.: P101086):');
        if (op) openEventosQuery({ op: op.trim().toUpperCase() });
      } else if (act === 'today') {
        const d = new Date();
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        openEventosQuery({ from: `${y}-${m}-${day}`, to: `${y}-${m}-${day}` });
      } else if (act === 'range') {
        const de  = prompt('Data inicial (AAAA-MM-DD):'); if (!de) return;
        const ate = prompt('Data final (AAAA-MM-DD):');   if (!ate) return;
        openEventosQuery({ from: de.trim(), to: ate.trim() });
      }
    });

    btnBaixarCsvGestao?.addEventListener('click', () => {
      const a = document.createElement('a');
      a.href = '/api/preparacao/csv';
      a.download = 'preparacao.csv';
      document.body.appendChild(a); a.click(); a.remove();
    });

    // ===== mini-board (aba Produto)
    window.ativarAbaProduto = function ativarAbaProduto() {
      setActive(menuProduto);
      paginaPrep.style.display = 'none';
      gestaoTab.style.display  = 'none';
      produtoTab.style.display = 'block';
    };

    async function renderMiniKanban(codigo) {
      miniCodigoEl.textContent = codigo ? `— ${codigo}` : '';
      ulMiniFila.innerHTML   = '';
      ulMiniEmProd.innerHTML = '';
      try {
        const resp = await fetch('/api/preparacao/listar', { cache: 'no-store' });
        const { mode, data } = await resp.json();
        console.log('[mini-board] mode =', mode);

const todos = [
  ...(data['A Produzir'] || []),
  ...(data['Produzindo'] || [])
];
        const itensDoProduto = todos.filter(c =>
          String(c.produto).trim() === String(codigo).trim()
        );

        if (!itensDoProduto.length) {
          ulMiniFila.innerHTML   = '<li class="empty">Nada encontrado</li>';
          ulMiniEmProd.innerHTML = '<li class="empty">—</li>';
          return;
        }

        for (const c of itensDoProduto) {
          const li = document.createElement('li');
          li.classList.add('kanban-card');
          li.textContent = c.op;
if (c.status === 'A Produzir') ulMiniFila.appendChild(li);
else if (c.status === 'Produzindo') ulMiniEmProd.appendChild(li);
        }

        if (!ulMiniFila.children.length)   ulMiniFila.innerHTML   = '<li class="empty">—</li>';
        if (!ulMiniEmProd.children.length) ulMiniEmProd.innerHTML = '<li class="empty">—</li>';
      } catch (err) {
        console.error(err);
        ulMiniFila.innerHTML   = '<li class="empty">Erro carregando dados</li>';
        ulMiniEmProd.innerHTML = '';
      }
    }
    window.renderMiniKanban = renderMiniKanban;

    document.getElementById('coluna-prep-fila')
      .addEventListener('click', (e) => {
        const card = e.target.closest('li');
        if (!card) return;
        let code =
          card.dataset?.codigo
          || card.querySelector('[data-codigo]')?.dataset?.codigo
          || card.querySelector('.codigo')?.textContent?.trim()
          || (card.innerText.match(/\b\d{2}\.[A-Z]{2}\.[A-Z]\.\d+\b/)?.[0]);
        if (!code) return;
        window.codigoSelecionado = code;
        window.ativarAbaProduto();
        renderMiniKanban(window.codigoSelecionado);
      });

      document.getElementById('coluna-prep-em-producao')
  .addEventListener('click', (e) => {
    const card = e.target.closest('li');
    if (!card) return;

    let code =
      card.dataset?.codigo
      || card.querySelector('[data-codigo]')?.dataset?.codigo
      || card.querySelector('.codigo')?.textContent?.trim()
      || (card.innerText.match(/\b\d{2}\.[A-Z]{2}\.[A-Z]\.\d+\b/)?.[0]);

    if (!code) return;

    window.codigoSelecionado = code;
    window.ativarAbaProduto();                 // já existe e abre a aba Produto
    renderMiniKanban(window.codigoSelecionado); // já renderiza o mini-kanban
  });


    // ===== QR: iniciar/finalizar produção
    const btnIniciar   = document.getElementById('btn-iniciar');
    const btnFinalizar = document.getElementById('btn-finalizar');

    btnIniciar?.addEventListener('click', (e) => {
      e.preventDefault();
      abrirLeitorQRComAcao('iniciar');
    });
    btnFinalizar?.addEventListener('click', (e) => {
      e.preventDefault();
      abrirLeitorQRComAcao('concluir');
    });

    async function abrirLeitorQRComAcao(acao) {
      if (!window.Html5Qrcode) {
        alert('Leitor indisponível. Recarregue a página.');
        return;
      }
      const qrModal     = document.getElementById('qrModal');
      const qrClose     = document.getElementById('qrClose');
      const html5QrCode = new window.Html5Qrcode('qrReader');
      let handled = false;

      const stop = async () => {
        try { await html5QrCode.stop(); html5QrCode.clear(); } catch {}
        qrModal.style.display = 'none';
      };

      const onScan = async (decodedText) => {
        if (handled) return;
        handled = true;
        await stop();

        const m  = decodedText.match(/P\d{3,}/i);
        const op = (m ? m[0] : (decodedText.split(',')[1] || decodedText))
                    .trim().toUpperCase();
        try {
          if (acao === 'iniciar') {
            await Preparacao.iniciarProducao(op);
          } else if (acao === 'concluir') {
            await Preparacao.finalizarProducao(op);
          }
          if (window.renderMiniKanban && window.codigoSelecionado) {
            await window.renderMiniKanban(window.codigoSelecionado);
          }
        } catch (err) {
          alert(`Falha ao ${acao === 'iniciar' ? 'iniciar' : 'finalizar'} produção: ${err.message || err}`);
        }
      };

      qrModal.style.display = 'block';
      try {
        await html5QrCode.start(
          { facingMode: 'environment' },
          {
            fps: 15,
            aspectRatio: 16/9,
            qrbox: (vw, vh) => {
              const size = Math.floor(Math.min(vw, vh) * 0.72);
              return { width: size, height: size };
            }
          },
          onScan
        );
      } catch (e) {
        alert('Não foi possível abrir a câmera: ' + (e.message || e));
        await stop();
        return;
      }

      qrClose.onclick = stop;
      qrModal.onclick = (e) => { if (e.target === qrModal) stop(); };
      const onEsc = (ev) => {
        if (ev.key === 'Escape' && qrModal.style.display === 'block') {
          document.removeEventListener('keydown', onEsc);
          stop();
        }
      };
      document.addEventListener('keydown', onEsc);
    }


      /* === Atualização ao vivo via SSE (webhook) — cole ANTES da linha que fecha o DOMContentLoaded === */
    (function setupLiveUpdates() {
      let debounceId;

      const refresh = async () => {
        clearTimeout(debounceId);
        debounceId = setTimeout(async () => {
          try {
            await initPreparacaoKanban();
            if (window.codigoSelecionado && typeof window.renderMiniKanban === 'function') {
              await window.renderMiniKanban(window.codigoSelecionado);
            }
          } catch (e) {
            console.warn('[prep-eletrica] refresh falhou:', e);
          }
        }, 300);
      };

      try {
        // SSE do servidor (rota já existente no seu server)
        const es = new EventSource('/api/produtos/stream');

        // ignora o "hello" inicial; qualquer outra msg → refresh
        es.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg && msg.type === 'hello') return;
          } catch {}
          refresh();
        };

        // fecha conexão ao sair da página
        window.addEventListener('beforeunload', () => es.close?.());
      } catch {
        // fallback se EventSource não existir
        setInterval(refresh, 20000);
      }
    })();
  });
</script>


<!-- Modal simples do QR -->
<div id="qrModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:520px;">
    <span class="close-modal" id="qrClose">&times;</span>
    <h3>Ler QR-Code</h3>
<div id="qrReader"></div>

  </div>
</div>



<script src="/preparacao_api.js"></script>

</body>
</html>

