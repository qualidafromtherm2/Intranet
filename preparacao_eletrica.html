<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Prepara√ß√£o el√©trica</title>
  <!-- Font Awesome para os √≠cones das fotos -->
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
  <!-- Seu CSS principal -->
  <link rel="stylesheet" href="menu_produto.css"/>
<style>
  /* Modal do leitor de QR */
  #qrModal{
    position: fixed; inset: 0; display:none;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    align-items: center; justify-content: center;
    padding: 24px;
  }
  #qrModal.open{ display:flex; }

  .qr-box{
    width: min(640px, 100%);
    background: var(--header-bg, #111);
    color: var(--text, #fff);
    border-radius: 16px;
    box-shadow: 0 12px 24px rgba(0,0,0,.35);
    padding: 16px;
  }
  .qr-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 12px;
  }
  .qr-close{
    appearance:none; border:0; background:transparent;
    font-size: 26px; line-height: 1; cursor: pointer; color: inherit;
  }
  /* o container que o html5-qrcode usa ajusta sozinho */
  #qrReader{ width:100%; }
</style>


  <style>
  /* layout: kanban √† esquerda e bot√£o √† direita */
  #produtoTab .produto-layout{
    display:flex;
    gap:16px;
    align-items:flex-start;
  }
  #produtoTab .mini-board{ flex:1; min-width:0; }
  #produtoTab .side-actions{
    width:220px;              /* largura fixa da coluna do bot√£o */
    flex:0 0 220px;
    display:flex;
    align-items:flex-start;
  }

  /* bot√£o moderno */
  #produtoTab .btn-modern{
    appearance:none;
    border:0;
    width:100%;
    padding:14px 18px;
    border-radius:16px;
    font-weight:600;
    letter-spacing:.2px;
    cursor:pointer;
    color:#fff;
    background: linear-gradient(135deg,#4f46e5,#22d3ee);
    box-shadow: 0 12px 22px rgba(79,70,229,.22),
                0 6px 10px rgba(34,211,238,.18);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  #produtoTab .btn-modern:hover{
    transform: translateY(-1px);
    box-shadow: 0 16px 26px rgba(79,70,229,.28),
                0 10px 14px rgba(34,211,238,.22);
  }
  #produtoTab .btn-modern:active{
    transform: translateY(0);
    filter: brightness(.96);
  }

  /* responsivo: bot√£o vai para baixo em telas estreitas */
  @media (max-width: 1100px){
    #produtoTab .produto-layout{ flex-direction:column; }
    #produtoTab .side-actions{ width:100%; flex:0 0 auto; }
  }
  /* ‚Äî QR em tela cheia "segura" no mobile ‚Äî */
#qrModal .modal-content{
  width: min(580px, 92vw);
  max-height: 90vh;
}

#qrReader{
  width: 100%;
  height: 60vh;           /* ocupa bem a tela */
  max-height: 75vh;
  background: #000;       /* fundo neutro, ajuda o contraste */
}

/* for√ßa o <video> interno a preencher bem e ficar mais claro */
#qrReader video{
  width: 100% !important;
  height: 100% !important;
  object-fit: cover;      /* preenche a √°rea mantendo corte elegante */
  filter: brightness(1.15) contrast(1.08);
}
/* empilha os bot√µes */
#produtoTab .btn-stack{
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}

/* variante "fantasma" para o Finalizar (ainda n√£o ativo) */
#produtoTab .btn-modern.btn-ghost{
  background: transparent;
  color: #4f46e5;
  box-shadow: inset 0 0 0 2px rgba(79,70,229,.45);
}
#produtoTab .btn-modern.btn-ghost:hover{
  transform: none;
  filter: none;
  box-shadow:
    inset 0 0 0 2px rgba(79,70,229,.65),
    0 2px 6px rgba(0,0,0,.06);
}

/* variante verde ‚Äúsucesso‚Äù */
#produtoTab .btn-modern.btn-success{
  background: linear-gradient(135deg,#16a34a,#22c55e);
  box-shadow: 0 12px 22px rgba(22,163,74,.22),
              0 6px 10px rgba(34,197,94,.18);
}
#produtoTab .btn-modern.btn-success:hover{
  transform: translateY(-1px);
  box-shadow: 0 16px 26px rgba(22,163,74,.28),
              0 10px 14px rgba(34,197,94,.22);
}

</style>

</head>
<body>


  <div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
    </svg>
  </div>

  <div class="app">
    <!-- Cabe√ßalho principal -->
<!-- ===== CABE√áALHO PRINCIPAL ===== -->
<div class="header" id="appHeader">
  <img class="menu-logo" src="../img/logo.png" alt="Logo da empresa" />

  <!-- Links que podem ‚Äúsobrar‚Äù -->
  <nav id="mainMenu" class="header-menu">
    

 <a id="menu-inicio"
    class="menu-link is-active"
    data-target="paginaInicio">In√≠cio</a>
    <a id="menu-produto" class="menu-link" href="#" data-target="produtoTab">Produto</a>
    <a id="menu-qualidade"     class="menu-link" href="#">Qualidade</a>
    <a id="menu-acessos"       class="menu-link" href="#">Acessos</a>
    <a id="menu-notificacoes"  class="menu-link" href="#">Notifica√ß√µes</a>
  </nav>

  <!-- Bot√£o ‚Ä¶  (fica invis√≠vel at√© o JS precisar dele) -->
<button id="moreBtn" class="more-btn" aria-label="Mais op√ß√µes">
  <!-- era: <i class="fa-solid fa-ellipsis-h"></i> -->
  <i class="fa-solid fa-ellipsis"></i>
</button>

  <!-- Campo de busca -->
  <div class="search-bar" id="searchBar">
    <input type="text" placeholder="Pesquisar produto" />
  </div>

  <!-- √çcones da direita -->
  <div class="header-profile">
    <div class="notification">
      <span class="notification-number">5</span>
      <i class="fa-solid fa-bell"></i>
    </div>
    <i class="fa-solid fa-print"></i>
    <i class="fa-solid fa-cloud"></i>
    <img id="profile-icon" class="profile-img"
         src="https://images.unsplash.com/photo-1600353068440-6361ef3a86e8?auto=format&fit=crop&w=1000&q=80"
         alt="Perfil">
  </div>

  <!-- Dropdown criado dinamicamente -->
  <div id="moreMenu" class="more-menu"></div>
</div>



    <div class="wrapper">

      <!-- ===== MENU LATERAL ===== -->
<div class="left-side">
  <div class="side-wrapper">
    <div class="side-title">Prepara√ß√£o el√©trica</div>

    <div class="side-menu">
      <!-- coloque links ou deixe vazio por enquanto -->
      <a href="#" class="menu-link">Em constru√ß√£o 1</a>
      <a href="#" class="menu-link">Em constru√ß√£o 2</a>
    </div>
  </div>
</div>


      <!-- Conte√∫do principal -->

      <!-- Painel In√≠cio ‚Äî aparece primeiro -->
<!-- Painel Prepara√ß√£o el√©trica -->
<div id="paginaPrepEletrica" class="tab-pane" style="display:block;">


  
  <!-- === bloco PREPARA√á√ÉO (Kanban) ============================ -->
<div id="conteudo-preparacao" class="kanban-page" >
  <div class="kanban-board">

    <!-- üü¶ Coluna 1: Fila de produ√ß√£o -->
    <div class="kanban-column">
<div class="kanban-header">
  <div class="title-wrapper"><span>Fila de produ√ß√£o</span></div>
  <i class="fas fa-plus add-btn" style="display:none"></i>
  <div class="add-container" style="display:none"></div>
</div>

      <ul id="coluna-prep-fila" class="kanban-list"></ul>
    </div>

    <!-- üü¶ Coluna 2: Em produ√ß√£o -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>Em produ√ß√£o</span>
      </div>
      <ul id="coluna-prep-em-producao" class="kanban-list"></ul>
    </div>

    <!-- üü¶ Coluna 3: No estoque -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>No estoque</span>
      </div>
      <ul id="coluna-prep-estoque" class="kanban-list"></ul>
    </div>

  </div><!-- /.kanban-board -->
</div>
<!-- ========================================================= -->
</div>



<!-- Guia Produto -->
<div id="produtoTab" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="title-wrapper">
      <div class="content-section-title">
        Produto  <span id="produtoSelecionado"></span>
      </div>
    </div>

<!-- layout lado-a-lado: kanban (esq) + bot√£o (dir) -->
<div class="produto-layout">
  <div class="kanban-board mini-board">
    <div class="kanban-column">
      <div class="kanban-header"><span>Fila de produ√ß√£o</span></div>
      <ul id="prod-col-fila" class="kanban-list"></ul>
    </div>

    <div class="kanban-column">
      <div class="kanban-header"><span>Em produ√ß√£o</span></div>
      <ul id="prod-col-emprod" class="kanban-list"></ul>
    </div>
  </div>

<div class="side-actions">
  <div class="btn-stack">
    <button id="btn-iniciar" class="btn-modern" type="button">
      Iniciar produ√ß√£o
    </button>

<button id="btn-finalizar" class="btn-modern btn-success" type="button">
  Finalizar produ√ß√£o
</button>


    <button id="btn-baixar-csv" class="btn-modern" type="button">
      Baixar CSV
    </button>
  </div>
</div>

</div>

  </div>
</div>




    </div> <!-- /.wrapper -->

    <div class="overlay-app" id="authOverlay"></div>
  </div> <!-- /.app -->



<!-- Modal de etiquetas ----------------------------->
<div id="etiquetasModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h3>Etiquetas dispon√≠veis</h3>
    <ul id="listaEtiquetas" class="etiquetas-list"></ul>
  </div>
</div>





  <!-- coloca logo antes do fechamento do body -->
<!-- coloque ANTES do seu script de inicializa√ß√£o -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script type="module" src="./kanban/kanban.js" defer></script>

<!-- coloca logo antes do fechamento do body -->
<script type="module">
  import { initPreparacaoKanban } from './kanban/kanban_preparacao.js';

  // use SEMPRE window.Html5Qrcode para garantir o escopo global
  const Html5Qrcode = window.Html5Qrcode;

  document.addEventListener('DOMContentLoaded', () => {
    initPreparacaoKanban();

const menuInicio    = document.getElementById('menu-inicio');
const menuProduto   = document.getElementById('menu-produto');
const paginaPrep    = document.getElementById('paginaPrepEletrica');
const produtoTab    = document.getElementById('produtoTab');           // <div id="produtoTab">
const miniCodigoEl  = document.getElementById('produtoSelecionado');   // <span id="produtoSelecionado">
const ulMiniFila    = document.getElementById('prod-col-fila');        // <ul id="prod-col-fila">
const ulMiniEmProd  = document.getElementById('prod-col-emprod');      // <ul id="prod-col-emprod">


window.codigoSelecionado = null;
  

window.ativarAbaProduto = function ativarAbaProduto() {

  document.querySelectorAll('#mainMenu .menu-link')
          .forEach(a => a.classList.remove('is-active'));
  menuProduto.classList.add('is-active');

  paginaPrep.style.display = 'none';
  produtoTab.style.display = 'block';
}


async function renderMiniKanban(codigo) {
  miniCodigoEl.textContent = codigo ? `‚Äî ${codigo}` : '';
  ulMiniFila.innerHTML   = '';
  ulMiniEmProd.innerHTML = '';

  try {
    const resp = await fetch('/api/preparacao/listar', { cache: 'no-store' });
    const { mode, data } = await resp.json();
    console.log('[mini-board] mode =', mode);

    // junta as duas colunas que exibimos na mini-board
    const todos = [
      ...(data['Fila de produ√ß√£o'] || []),
      ...(data['Em produ√ß√£o']      || [])
    ];

    const itensDoProduto = todos.filter(c =>
      String(c.produto).trim() === String(codigo).trim()
    );

    if (!itensDoProduto.length) {
      ulMiniFila.innerHTML   = '<li class="empty">Nada encontrado</li>';
      ulMiniEmProd.innerHTML = '<li class="empty">‚Äî</li>';
      return;
    }

    for (const c of itensDoProduto) {
      const li = document.createElement('li');
      li.classList.add('kanban-card');
      li.textContent = c.op;

      if (c.status === 'Fila de produ√ß√£o') {
        ulMiniFila.appendChild(li);
      } else if (c.status === 'Em produ√ß√£o') {
        ulMiniEmProd.appendChild(li);
      }
    }

    if (!ulMiniFila.children.length)   ulMiniFila.innerHTML   = '<li class="empty">‚Äî</li>';
    if (!ulMiniEmProd.children.length) ulMiniEmProd.innerHTML = '<li class="empty">‚Äî</li>';

  } catch (err) {
    console.error(err);
    ulMiniFila.innerHTML   = '<li class="empty">Erro carregando dados</li>';
    ulMiniEmProd.innerHTML = '';
  }
}
window.renderMiniKanban = renderMiniKanban;



    // ‚Äî Clique SOMENTE na "Fila de produ√ß√£o" do kanban desta p√°gina ‚Äî
    document.getElementById('coluna-prep-fila')
      .addEventListener('click', (e) => {
        const card = e.target.closest('li');
        if (!card) return;

        // tenta achar o c√≥digo do produto
        let code =
          card.dataset?.codigo
          || card.querySelector('[data-codigo]')?.dataset?.codigo
          || card.querySelector('.codigo')?.textContent?.trim()
          || (card.innerText.match(/\b\d{2}\.[A-Z]{2}\.[A-Z]\.\d+\b/)?.[0]); // ex.: 04.PP.N.51004

        if (!code) return; // sem c√≥digo, n√£o tem o que filtrar

        window.codigoSelecionado = code;
        ativarAbaProduto();
        renderMiniKanban(window.codigoSelecionado);
      });

    // ‚Äî Clicar em "Produto" na barra apenas mostra a aba (sem sele√ß√£o) ‚Äî
    menuProduto.addEventListener('click', (e) => {
      e.preventDefault();
      ativarAbaProduto();
      if (window.codigoSelecionado) {
        renderMiniKanban(window.codigoSelecionado);
      } else {
        miniCodigoEl.textContent = '';
        ulMiniFila.innerHTML     = '<li class="empty">Selecione um item na Fila de produ√ß√£o</li>';
        ulMiniEmProd.innerHTML   = '<li class="empty">‚Äî</li>';
      }
    });

    // ‚Äî Voltar para a prepara√ß√£o ao clicar em In√≠cio ‚Äî
    menuInicio.addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelectorAll('#mainMenu .menu-link')
              .forEach(a => a.classList.remove('is-active'));
      menuInicio.classList.add('is-active');
produtoTab.style.display = 'none';
paginaPrep.style.display = 'block';

    });

  });



  // ===== Leitor QR (somente nesta p√°gina) =====
// ===== Leitor QR (somente nesta p√°gina) =====
const btnIniciar    = document.getElementById('btn-iniciar');
const btnFinalizar  = document.getElementById('btn-finalizar');
const btnBaixarCsv  = document.getElementById('btn-baixar-csv');

btnIniciar?.addEventListener('click', (e) => {
  e.preventDefault();
  abrirLeitorQRComAcao('iniciar');
});

btnFinalizar?.addEventListener('click', (e) => {
  e.preventDefault();
  abrirLeitorQRComAcao('concluir'); // muda para "No estoque"
});

// btnBaixarCsv j√° deve estar com o fetch do CSV




// L√™ QR e executa a a√ß√£o: 'iniciar' ‚Üí Em produ√ß√£o | 'concluir' ‚Üí No estoque
async function abrirLeitorQRComAcao(acao) {
  if (!window.Html5Qrcode) {
    alert('Leitor indispon√≠vel. Recarregue a p√°gina.');
    return;
  }

  const qrModal = document.getElementById('qrModal');
  const qrClose = document.getElementById('qrClose');
  const html5QrCode = new window.Html5Qrcode('qrReader');

  const stop = async () => {
    try { await html5QrCode.stop(); html5QrCode.clear(); } catch {}
    qrModal.style.display = 'none';
  };

  const onScan = async (decodedText) => {
    // extrai algo tipo P101086 do QR
    const m  = decodedText.match(/P\d{3,}/i);
    const op = (m ? m[0] : (decodedText.split(',')[1] || decodedText))
                .trim().toUpperCase();

    try {
      if (acao === 'iniciar') {
        await Preparacao.iniciarProducao(op);
        alert(`OP ${op} movida para "Em produ√ß√£o".`);
      } else if (acao === 'concluir') {
        // precisa existir em preparacao_api.js
        await Preparacao.finalizarProducao(op);
        alert(`OP ${op} movida para "No estoque".`);
      }

      // atualiza mini-board se voc√™ tiver um produto selecionado
      if (window.renderMiniKanban && window.codigoSelecionado) {
        await window.renderMiniKanban(window.codigoSelecionado);
      }
    } catch (err) {
      const txt = (acao === 'iniciar') ? 'iniciar' : 'finalizar';
      alert(`Falha ao ${txt} produ√ß√£o: ${err.message || err}`);
    } finally {
      await stop();
    }
  };

  // abre modal e inicia c√¢mera (traseira quando poss√≠vel)
  qrModal.style.display = 'block';
  const camConstraints = { facingMode: 'environment' };
  try {
    await html5QrCode.start(
      camConstraints,
      {
        fps: 15,
        aspectRatio: 16/9,
        qrbox: (vw, vh) => {
          const size = Math.floor(Math.min(vw, vh) * 0.72);
          return { width: size, height: size };
        }
      },
      onScan
    );
  } catch (e) {
    alert('N√£o foi poss√≠vel abrir a c√¢mera: ' + (e.message || e));
    await stop();
  }

  // fechar
  qrClose.onclick = stop;
  qrModal.onclick = (e) => { if (e.target === qrModal) stop(); };
  const onEsc = (ev) => { if (ev.key === 'Escape' && qrModal.style.display === 'block') { 
    document.removeEventListener('keydown', onEsc); stop(); 
  }};
  document.addEventListener('keydown', onEsc);
}


// placeholder ‚Äî vamos implementar depois
btnFinalizar?.addEventListener('click', () => {
  alert('Finalizar produ√ß√£o: em breve ü§ù');
});

// download do CSV (funciona tanto local quanto via Render/Cloudflare)
btnBaixarCsv?.addEventListener('click', () => {
  // forma compat√≠vel: cria um <a> invis√≠vel e clica
  const a = document.createElement('a');
  a.href = '/api/preparacao/csv';
  a.download = 'preparacao.csv'; // hint pro navegador
  document.body.appendChild(a);
  a.click();
  a.remove();
});

  const qrModal    = document.getElementById('qrModal');
  const qrClose    = document.getElementById('qrClose');





    // Escolhe a c√¢mera traseira (quando houver)
  async function pickRearCamera() {
    try {
      const devices = await window.Html5Qrcode.getCameras();
      if (!devices || !devices.length) return null;
      const prefer = devices.find(d => /back|tr√°s|rear|environment/i.test(d.label));
      return (prefer?.id) || devices[0].id; // fallback para a 1¬™
    } catch {
      return null;
    }
  }

async function abrirLeitorQR() {
  if (!window.Html5Qrcode) {
    alert('Leitor indispon√≠vel. Recarregue a p√°gina.');
    return;
  }

  // abre o modal
  qrModal.style.display = 'block';

  const html5QrCode = new window.Html5Qrcode('qrReader');

  // fecha/limpa
  const stop = async () => {
    try { await html5QrCode.stop(); html5QrCode.clear(); } catch {}
    qrModal.style.display = 'none';
  };

// quando ler um QR
const onScan = async (decodedText) => {
  // pega OP (Pxxxxx)
  const m  = decodedText.match(/P\d{3,}/i);
  const op = (m ? m[0] : (decodedText.split(',')[1] || decodedText)).trim().toUpperCase();

  try {
    // 1) Manda iniciar no servidor (vai para ‚ÄúEm produ√ß√£o‚Äù)
    const data = await window.Preparacao.iniciarProducao(op);
    // data = { 'Fila de produ√ß√£o': [...], 'Em produ√ß√£o': [...], 'No estoque': [...] }

    // 2) descobre o c√≥digo do produto pela OP nos dados retornados
    const produtoDoOp =
      Object.values(data).flat().find(c => c.op === op)?.produto;

    // 3) mostra a aba Produto e atualiza o mini-kanban daquele c√≥digo
    window.ativarAbaProduto();
    if (produtoDoOp) {
      codigoSelecionado = produtoDoOp;
      await renderMiniKanban(codigoSelecionado);
    }

    // (opcional) se voc√™ quiser, pode tamb√©m recarregar o quadro grande:
    // window.KanbanPrep?.reload?.();

  } catch (err) {
    console.error(err);
    alert('Falha ao iniciar produ√ß√£o: ' + (err.message || err));
  } finally {
    // fecha o leitor
    try { await html5QrCode.stop(); html5QrCode.clear(); } catch {}
    qrModal.style.display = 'none';
  }
};




  // helper para tentar iniciar e logar erro sem travar
  const tryStart = async (constraints, config) => {
    try {
      await html5QrCode.start(constraints, config, onScan);
      return true;
    } catch (e) {
      console.warn('start falhou:', e?.name, e?.message);
      return false;
    }
  };

  // escolher a c√¢mera: tenta a traseira real
  let camConstraints;
  try {
    const cams = await window.Html5Qrcode.getCameras();
    if (cams && cams.length) {
      const rear = cams.find(c => /back|rear|environment|tr√°s/i.test(c.label)) || cams[0];
      camConstraints = { deviceId: { exact: rear.id } };
    } else {
      camConstraints = { facingMode: 'environment' };
    }
  } catch {
    camConstraints = { facingMode: 'environment' };
  }

  // TENTATIVA 1 ‚Äî configura√ß√£o simples (compat√≠vel)
let ok = await tryStart(
  camConstraints,
  {
    fps: 15,
    aspectRatio: 16 / 9,
    qrbox: (vw, vh) => {
      const size = Math.floor(Math.min(vw, vh) * 0.72);
      return { width: size, height: size };
    }
  }
);


  // fallback ‚Äî ainda mais leve
if (!ok) ok = await tryStart(
  { facingMode: 'environment' },
  {
    fps: 12,
    aspectRatio: 16 / 9,
    qrbox: (vw, vh) => {
      const size = Math.floor(Math.min(vw, vh) * 0.70);
      return { width: size, height: size };
    }
  }
);


  if (!ok) {
    alert('N√£o foi poss√≠vel abrir a c√¢mera. Verifique as permiss√µes e tente novamente.');
    await stop();
    return;
  }

  // p√≥s-start: melhora foco/zoom/torch se suportado (n√£o quebra se n√£o tiver)
  if (typeof html5QrCode.getRunningTrackCapabilities === 'function' &&
      typeof html5QrCode.applyVideoConstraints === 'function') {
    try {
      const caps = await html5QrCode.getRunningTrackCapabilities();
      const adv = [];
      const focusList = Array.isArray(caps?.focusMode) ? caps.focusMode : [caps?.focusMode];
      if (focusList?.includes?.('continuous')) adv.push({ focusMode: 'continuous' });
      if (caps?.zoom)  adv.push({ zoom: Math.min(caps.zoom.max || 2, 2) });
      if (caps?.torch) adv.push({ torch: true });
      if (adv.length) await html5QrCode.applyVideoConstraints({ advanced: adv });
    } catch {}
  }

  // fechar no X / fora / ESC
  qrClose.onclick = stop;
  qrModal.onclick = (e) => { if (e.target === qrModal) stop(); };
  document.addEventListener('keydown', function onEsc(ev){
    if (ev.key === 'Escape' && qrModal.style.display === 'block') {
      document.removeEventListener('keydown', onEsc);
      stop();
    }
  });
}




function fecharLeitorQR(){
  // para a c√¢mera e limpa
  if (qr && qr.isScanning) {
    qr.stop().then(() => qr.clear());
  }
  qrModal.classList.remove('open');
}

qrClose?.addEventListener('click', fecharLeitorQR);
// fecha clicando fora da caixa
qrModal.addEventListener('click', (e) => {
  if (e.target === qrModal) fecharLeitorQR();
});
// fecha com ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && qrModal.classList.contains('open')) fecharLeitorQR();
});

</script>

<!-- Modal simples do QR -->
<div id="qrModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:520px;">
    <span class="close-modal" id="qrClose">&times;</span>
    <h3>Ler QR-Code</h3>
<div id="qrReader"></div>

  </div>
</div>



<script src="/preparacao_api.js"></script>

</body>
</html>

