<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Prepara√ß√£o el√©trica</title>
  <!-- Font Awesome para os √≠cones das fotos -->
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
  <!-- Seu CSS principal -->
  <link rel="stylesheet" href="menu_produto.css"/>
<style>
  /* Modal do leitor de QR */
  #qrModal{
    position: fixed; inset: 0; display:none;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    align-items: center; justify-content: center;
    padding: 24px;
  }
  #qrModal.open{ display:flex; }

  .qr-box{
    width: min(640px, 100%);
    background: var(--header-bg, #111);
    color: var(--text, #fff);
    border-radius: 16px;
    box-shadow: 0 12px 24px rgba(0,0,0,.35);
    padding: 16px;
  }
  .qr-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom: 12px;
  }
  .qr-close{
    appearance:none; border:0; background:transparent;
    font-size: 26px; line-height: 1; cursor: pointer; color: inherit;
  }
  /* o container que o html5-qrcode usa ajusta sozinho */
  #qrReader{ width:100%; }
</style>


  <style>
  /* layout: kanban √† esquerda e bot√£o √† direita */
  #produtoTab .produto-layout{
    display:flex;
    gap:16px;
    align-items:flex-start;
  }
  #produtoTab .mini-board{ flex:1; min-width:0; }
  #produtoTab .side-actions{
    width:220px;              /* largura fixa da coluna do bot√£o */
    flex:0 0 220px;
    display:flex;
    align-items:flex-start;
  }

  /* bot√£o moderno */
  #produtoTab .btn-modern{
    appearance:none;
    border:0;
    width:100%;
    padding:14px 18px;
    border-radius:16px;
    font-weight:600;
    letter-spacing:.2px;
    cursor:pointer;
    color:#fff;
    background: linear-gradient(135deg,#4f46e5,#22d3ee);
    box-shadow: 0 12px 22px rgba(79,70,229,.22),
                0 6px 10px rgba(34,211,238,.18);
    transition: transform .12s ease, box-shadow .2s ease, filter .2s ease;
  }
  #produtoTab .btn-modern:hover{
    transform: translateY(-1px);
    box-shadow: 0 16px 26px rgba(79,70,229,.28),
                0 10px 14px rgba(34,211,238,.22);
  }
  #produtoTab .btn-modern:active{
    transform: translateY(0);
    filter: brightness(.96);
  }

  /* responsivo: bot√£o vai para baixo em telas estreitas */
  @media (max-width: 1100px){
    #produtoTab .produto-layout{ flex-direction:column; }
    #produtoTab .side-actions{ width:100%; flex:0 0 auto; }
  }
</style>

</head>
<body>


  <div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
    </svg>
  </div>

  <div class="app">
    <!-- Cabe√ßalho principal -->
<!-- ===== CABE√áALHO PRINCIPAL ===== -->
<div class="header" id="appHeader">
  <img class="menu-logo" src="../img/logo.png" alt="Logo da empresa" />

  <!-- Links que podem ‚Äúsobrar‚Äù -->
  <nav id="mainMenu" class="header-menu">
    

 <a id="menu-inicio"
    class="menu-link is-active"
    data-target="paginaInicio">In√≠cio</a>
    <a id="menu-produto" class="menu-link" href="#" data-target="produtoTab">Produto</a>
    <a id="menu-qualidade"     class="menu-link" href="#">Qualidade</a>
    <a id="menu-acessos"       class="menu-link" href="#">Acessos</a>
    <a id="menu-notificacoes"  class="menu-link" href="#">Notifica√ß√µes</a>
  </nav>

  <!-- Bot√£o ‚Ä¶  (fica invis√≠vel at√© o JS precisar dele) -->
<button id="moreBtn" class="more-btn" aria-label="Mais op√ß√µes">
  <!-- era: <i class="fa-solid fa-ellipsis-h"></i> -->
  <i class="fa-solid fa-ellipsis"></i>
</button>

  <!-- Campo de busca -->
  <div class="search-bar" id="searchBar">
    <input type="text" placeholder="Pesquisar produto" />
  </div>

  <!-- √çcones da direita -->
  <div class="header-profile">
    <div class="notification">
      <span class="notification-number">5</span>
      <i class="fa-solid fa-bell"></i>
    </div>
    <i class="fa-solid fa-print"></i>
    <i class="fa-solid fa-cloud"></i>
    <img id="profile-icon" class="profile-img"
         src="https://images.unsplash.com/photo-1600353068440-6361ef3a86e8?auto=format&fit=crop&w=1000&q=80"
         alt="Perfil">
  </div>

  <!-- Dropdown criado dinamicamente -->
  <div id="moreMenu" class="more-menu"></div>
</div>



    <div class="wrapper">

      <!-- ===== MENU LATERAL ===== -->
<div class="left-side">
  <div class="side-wrapper">
    <div class="side-title">Prepara√ß√£o el√©trica</div>

    <div class="side-menu">
      <!-- coloque links ou deixe vazio por enquanto -->
      <a href="#" class="menu-link">Em constru√ß√£o 1</a>
      <a href="#" class="menu-link">Em constru√ß√£o 2</a>
    </div>
  </div>
</div>


      <!-- Conte√∫do principal -->

      <!-- Painel In√≠cio ‚Äî aparece primeiro -->
<!-- Painel Prepara√ß√£o el√©trica -->
<div id="paginaPrepEletrica" class="tab-pane" style="display:block;">


  
  <!-- === bloco PREPARA√á√ÉO (Kanban) ============================ -->
<div id="conteudo-preparacao" class="kanban-page" >
  <div class="kanban-board">

    <!-- üü¶ Coluna 1: Fila de produ√ß√£o -->
    <div class="kanban-column">
<div class="kanban-header">
  <div class="title-wrapper"><span>Fila de produ√ß√£o</span></div>
  <i class="fas fa-plus add-btn" style="display:none"></i>
  <div class="add-container" style="display:none"></div>
</div>

      <ul id="coluna-prep-fila" class="kanban-list"></ul>
    </div>

    <!-- üü¶ Coluna 2: Em produ√ß√£o -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>Em produ√ß√£o</span>
      </div>
      <ul id="coluna-prep-em-producao" class="kanban-list"></ul>
    </div>

    <!-- üü¶ Coluna 3: No estoque -->
    <div class="kanban-column">
      <div class="kanban-header">
        <span>No estoque</span>
      </div>
      <ul id="coluna-prep-estoque" class="kanban-list"></ul>
    </div>

  </div><!-- /.kanban-board -->
</div>
<!-- ========================================================= -->
</div>



<!-- Guia Produto -->
<div id="produtoTab" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="title-wrapper">
      <div class="content-section-title">
        Produto  <span id="produtoSelecionado"></span>
      </div>
    </div>

<!-- layout lado-a-lado: kanban (esq) + bot√£o (dir) -->
<div class="produto-layout">
  <div class="kanban-board mini-board">
    <div class="kanban-column">
      <div class="kanban-header"><span>Fila de produ√ß√£o</span></div>
      <ul id="prod-col-fila" class="kanban-list"></ul>
    </div>

    <div class="kanban-column">
      <div class="kanban-header"><span>Em produ√ß√£o</span></div>
      <ul id="prod-col-emprod" class="kanban-list"></ul>
    </div>
  </div>

  <div class="side-actions">
    <button id="btn-iniciar" class="btn-modern" type="button">
      Iniciar produ√ß√£o
    </button>
  </div>
</div>

  </div>
</div>




    </div> <!-- /.wrapper -->

    <div class="overlay-app" id="authOverlay"></div>
  </div> <!-- /.app -->



<!-- Modal de etiquetas ----------------------------->
<div id="etiquetasModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h3>Etiquetas dispon√≠veis</h3>
    <ul id="listaEtiquetas" class="etiquetas-list"></ul>
  </div>
</div>





  <!-- coloca logo antes do fechamento do body -->
<!-- coloque ANTES do seu script de inicializa√ß√£o -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script type="module" src="./kanban/kanban.js" defer></script>

<!-- coloca logo antes do fechamento do body -->
<script type="module">
  import { initPreparacaoKanban } from './kanban/kanban_preparacao.js';

  // use SEMPRE window.Html5Qrcode para garantir o escopo global
  const Html5Qrcode = window.Html5Qrcode;

  document.addEventListener('DOMContentLoaded', () => {
    initPreparacaoKanban();

const menuInicio    = document.getElementById('menu-inicio');
const menuProduto   = document.getElementById('menu-produto');
const paginaPrep    = document.getElementById('paginaPrepEletrica');
const produtoTab    = document.getElementById('produtoTab');           // <div id="produtoTab">
const miniCodigoEl  = document.getElementById('produtoSelecionado');   // <span id="produtoSelecionado">
const ulMiniFila    = document.getElementById('prod-col-fila');        // <ul id="prod-col-fila">
const ulMiniEmProd  = document.getElementById('prod-col-emprod');      // <ul id="prod-col-emprod">


    let codigoSelecionado = null;

window.ativarAbaProduto = function ativarAbaProduto() {

  document.querySelectorAll('#mainMenu .menu-link')
          .forEach(a => a.classList.remove('is-active'));
  menuProduto.classList.add('is-active');

  paginaPrep.style.display = 'none';
  produtoTab.style.display = 'block';
}


    async function renderMiniKanban(codigo) {
      miniCodigoEl.textContent = codigo ? `‚Äî ${codigo}` : '';
      ulMiniFila.innerHTML   = '';
      ulMiniEmProd.innerHTML = '';

      try {
        const resp  = await fetch('data/kanban_preparacao.json', { cache: 'no-store' });
        const lista = await resp.json();

        const item = lista.find(x => String(x.codigo).trim() === String(codigo).trim());
        if (!item) {
          ulMiniFila.innerHTML = '<li class="empty">Nada encontrado</li>';
          return;
        }

        (item.local || []).forEach(linha => {
          const [status, op] = String(linha).split(',').map(s => s.trim());
const li = document.createElement('li');
li.textContent = op || linha;   // exibe s√≥ o c√≥digo da OP
li.classList.add('kanban-card');


          if (status === 'Fila de produ√ß√£o') {
            ulMiniFila.appendChild(li);
          } else if (status === 'Em produ√ß√£o') {
            ulMiniEmProd.appendChild(li);
          }
        });

        // se n√£o tiver nenhum item em algum lado, mostra vazio bonito
        if (!ulMiniFila.children.length)    ulMiniFila.innerHTML    = '<li class="empty">‚Äî</li>';
        if (!ulMiniEmProd.children.length)  ulMiniEmProd.innerHTML  = '<li class="empty">‚Äî</li>';

      } catch (err) {
        ulMiniFila.innerHTML   = '<li class="empty">Erro carregando JSON</li>';
        ulMiniEmProd.innerHTML = '';
        console.error(err);
      }
    }

    // ‚Äî Clique SOMENTE na "Fila de produ√ß√£o" do kanban desta p√°gina ‚Äî
    document.getElementById('coluna-prep-fila')
      .addEventListener('click', (e) => {
        const card = e.target.closest('li');
        if (!card) return;

        // tenta achar o c√≥digo do produto
        let code =
          card.dataset?.codigo
          || card.querySelector('[data-codigo]')?.dataset?.codigo
          || card.querySelector('.codigo')?.textContent?.trim()
          || (card.innerText.match(/\b\d{2}\.[A-Z]{2}\.[A-Z]\.\d+\b/)?.[0]); // ex.: 04.PP.N.51004

        if (!code) return; // sem c√≥digo, n√£o tem o que filtrar

        codigoSelecionado = code;
        ativarAbaProduto();
        renderMiniKanban(codigoSelecionado);
      });

    // ‚Äî Clicar em "Produto" na barra apenas mostra a aba (sem sele√ß√£o) ‚Äî
    menuProduto.addEventListener('click', (e) => {
      e.preventDefault();
      ativarAbaProduto();
      if (codigoSelecionado) {
        renderMiniKanban(codigoSelecionado);
      } else {
        miniCodigoEl.textContent = '';
        ulMiniFila.innerHTML     = '<li class="empty">Selecione um item na Fila de produ√ß√£o</li>';
        ulMiniEmProd.innerHTML   = '<li class="empty">‚Äî</li>';
      }
    });

    // ‚Äî Voltar para a prepara√ß√£o ao clicar em In√≠cio ‚Äî
    menuInicio.addEventListener('click', (e) => {
      e.preventDefault();
      document.querySelectorAll('#mainMenu .menu-link')
              .forEach(a => a.classList.remove('is-active'));
      menuInicio.classList.add('is-active');
produtoTab.style.display = 'none';
paginaPrep.style.display = 'block';

    });

  });



  // ===== Leitor QR (somente nesta p√°gina) =====
  const btnIniciar = document.getElementById('btn-iniciar');
  const qrModal    = document.getElementById('qrModal');
  const qrClose    = document.getElementById('qrClose');


    // Escolhe a c√¢mera traseira (quando houver)
  async function pickRearCamera() {
    try {
      const devices = await window.Html5Qrcode.getCameras();
      if (!devices || !devices.length) return null;
      const prefer = devices.find(d => /back|tr√°s|rear|environment/i.test(d.label));
      return (prefer?.id) || devices[0].id; // fallback para a 1¬™
    } catch {
      return null;
    }
  }

  async function abrirLeitorQR() {
    if (typeof window.Html5Qrcode !== 'function') {
      alert('Leitor indispon√≠vel. Recarregue a p√°gina.');
      return;
    }

    qrModal.style.display = 'block';

const html5QrCode = new window.Html5Qrcode('qrReader');

// tamanho do quadrado de leitura ‚Äî maior no desktop, menor no mobile
const qrboxSide = Math.min(360, Math.floor(window.innerWidth * 0.8));

// tenta pegar a c√¢mera traseira real; se n√£o achar, usa facingMode
const cameraId = await pickRearCamera();

// config mais ‚Äúrobusta‚Äù para celular
const config = {
  fps: 15,                         // taxa boa p/ foco e leitura
  qrbox: { width: qrboxSide, height: qrboxSide },
  aspectRatio: 1.777,              // 16:9 costuma funcionar melhor no mobile
  videoConstraints: {
    // se cameraId existir, ele ser√° usado no start (abaixo)
    facingMode: 'environment',
    focusMode: 'continuous',       // alguns navegadores ignoram, outros respeitam
    width:  { ideal: 1280 },
    height: { ideal: 720 }
  }
};

const finalize = async () => {
  try { await html5QrCode.stop(); html5QrCode.clear(); } catch {}
  qrModal.style.display = 'none';
};

try {
  await html5QrCode.start(
    cameraId ? { deviceId: { exact: cameraId } } : { facingMode: 'environment' },
    config,
    (decodedText /*, decodedResult*/) => {
      // ======= seu handler de QR (permanece igual) =======
      const op = (decodedText.split(',')[1] || decodedText).trim();
      const agora   = new Date();
      const carimbo = agora.toLocaleDateString('pt-BR') + ' - ' +
                      agora.toLocaleTimeString('pt-BR', { hour12:false });

      fetch('data/kanban_preparacao.json', { cache:'no-store' })
        .then(r => r.json())
        .then(lista => {
          let alvo = null, idx = -1;
          for (const it of lista) {
            idx = (it.local || []).findIndex(l =>
              l.startsWith('Fila de produ√ß√£o,') && l.includes(op)
            );
            if (idx !== -1) { alvo = it; break; }
          }

          if (!alvo) {
            alert(`OP ${op} n√£o encontrada na Fila de produ√ß√£o.`);
            return;
          }

          alvo.local[idx] = `Em produ√ß√£o,${op},${carimbo}`;
          window.ativarAbaProduto?.();
          document.getElementById('produtoSelecionado').textContent = `‚Äî ${alvo.codigo}`;

          const ulMiniFila   = document.getElementById('prod-col-fila');
          const ulMiniEmProd = document.getElementById('prod-col-emprod');
          ulMiniFila.innerHTML = '';
          ulMiniEmProd.innerHTML = '';

          (alvo.local || []).forEach(linha => {
            const [status, opCode, stamp] = String(linha).split(',').map(s => s.trim());
            const li = document.createElement('li');
            li.classList.add('kanban-card');
            li.textContent = stamp ? `${opCode} ‚Äî ${stamp}` : opCode;
            if (status === 'Fila de produ√ß√£o') ulMiniFila.appendChild(li);
            else if (status === 'Em produ√ß√£o') ulMiniEmProd.appendChild(li);
          });

          if (!ulMiniFila.children.length)   ulMiniFila.innerHTML   = '<li class="empty">‚Äî</li>';
          if (!ulMiniEmProd.children.length) ulMiniEmProd.innerHTML = '<li class="empty">‚Äî</li>';
        })
        .catch(err => {
          console.error(err);
          alert('Falha ao ler/atualizar a fila local.');
        })
        .finally(() => finalize());
      // ======= /handler =======
    }
  );

  // P√≥s-start: tenta melhorar foco, zoom e ligar torch se suportado
  if (typeof html5QrCode.getRunningTrackCapabilities === 'function' &&
      typeof html5QrCode.applyVideoConstraints === 'function') {
    const caps = await html5QrCode.getRunningTrackCapabilities();
    const adv = [];

    // liga o flash/torch se existir
    if (caps?.torch) adv.push({ torch: true });

    // solicita foco cont√≠nuo, quando suportado (string ou array)
    const focusModes = Array.isArray(caps?.focusMode) ? caps.focusMode : [caps?.focusMode];
    if (focusModes?.includes?.('continuous')) adv.push({ focusMode: 'continuous' });

    // um pouco de zoom ajuda MUITO a focar QR pequeno
    if (caps?.zoom) {
      const target = Math.min(caps.zoom.max ?? 1, Math.max(caps.zoom.min ?? 1, 2));
      adv.push({ zoom: target });
    }

    if (adv.length) {
      try { await html5QrCode.applyVideoConstraints({ advanced: adv }); } catch {}
    }
  }

} catch (err) {
  console.error(err);
  alert('N√£o foi poss√≠vel abrir a c√¢mera.\nDica: use HTTPS ou localhost e libere a permiss√£o.');
  finalize();
}


    // fechar no X
    qrClose.onclick = finalize;
    // fechar clicando fora
    qrModal.onclick = (e) => { if (e.target === qrModal) finalize(); };
    // fechar com ESC
    document.addEventListener('keydown', function onEsc(ev){
      if (ev.key === 'Escape' && qrModal.style.display === 'block') {
        document.removeEventListener('keydown', onEsc);
        finalize();
      }
    });
  }

  // bot√£o ‚ÄúIniciar produ√ß√£o‚Äù
  btnIniciar?.addEventListener('click', (e) => {
    e.preventDefault();
    abrirLeitorQR();
  });



function fecharLeitorQR(){
  // para a c√¢mera e limpa
  if (qr && qr.isScanning) {
    qr.stop().then(() => qr.clear());
  }
  qrModal.classList.remove('open');
}

// A√ß√µes
btnIniciar?.addEventListener('click', (e) => {
  e.preventDefault();
  abrirLeitorQR().catch(err => {
    console.error(err);
    alert('N√£o foi poss√≠vel abrir a c√¢mera.\nDica: use HTTPS ou localhost.');
    fecharLeitorQR();
  });
});
qrClose?.addEventListener('click', fecharLeitorQR);
// fecha clicando fora da caixa
qrModal.addEventListener('click', (e) => {
  if (e.target === qrModal) fecharLeitorQR();
});
// fecha com ESC
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape' && qrModal.classList.contains('open')) fecharLeitorQR();
});

</script>

<!-- Modal simples do QR -->
<div id="qrModal" class="modal" style="display:none;">
  <div class="modal-content" style="max-width:520px;">
    <span class="close-modal" id="qrClose">&times;</span>
    <h3>Ler QR-Code</h3>
    <div id="qrReader" style="width:480px; height:320px; margin-top:10px;"></div>
  </div>
</div>

</body>
</html>

