<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Produtos</title>
  <!-- Font Awesome para os ícones das fotos -->
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer"
/>
  <!-- Seu CSS principal -->
  <link rel="stylesheet" href="menu_produto.css"/>
</head>
<body>

  <div class="dark-light">
    <svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" fill="none"
         stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z" />
    </svg>
  </div>

  <div class="app">
    <!-- Cabeçalho principal -->
<!-- ===== CABEÇALHO PRINCIPAL ===== -->
<div class="header" id="appHeader">
  <img class="menu-logo" src="../img/logo.png" alt="Logo da empresa" />

  <!-- Links que podem “sobrar” -->
<nav id="mainMenu" class="header-menu">

  <a id="menu-inicio"
     class="menu-link is-active"
     data-target="paginaInicio"
     data-nav-key="top:inicio"
     data-nav-pos="top"
     data-nav-label="Início"
     data-nav-selector="#menu-inicio">Início</a>

  <a id="menu-produto"
     class="menu-link" href="#"
     data-nav-key="top:produto"
     data-nav-pos="top"
     data-nav-label="Produto"
     data-nav-selector="#menu-produto">Produto</a>

  <a id="menu-qualidade"
     class="menu-link" href="#"
     data-nav-key="top:qualidade"
     data-nav-pos="top"
     data-nav-label="Qualidade"
     data-nav-selector="#menu-qualidade">Qualidade</a>

  <a id="menu-acessos"
     class="menu-link" href="#"
     data-nav-key="top:acessos"
     data-nav-pos="top"
     data-nav-label="Acessos"
     data-nav-selector="#menu-acessos">Acessos</a>

  <a id="menu-notificacoes"
     class="menu-link" href="#"
     data-nav-key="top:notificacoes"
     data-nav-pos="top"
     data-nav-label="Notificações"
     data-nav-selector="#menu-notificacoes">Notificações</a>
</nav>


  <!-- Botão …  (fica invisível até o JS precisar dele) -->
<button id="moreBtn" class="more-btn" aria-label="Mais opções">
  <!-- era: <i class="fa-solid fa-ellipsis-h"></i> -->
  <i class="fa-solid fa-ellipsis"></i>
</button>

  <!-- Campo de busca -->
  <div class="search-bar" id="searchBar">
    <input type="text" placeholder="Pesquisar produto" />
  </div>

  <!-- Ícones da direita -->
  <div class="header-profile">
    <div class="notification">
      <span class="notification-number">5</span>
      <i class="fa-solid fa-bell"></i>
    </div>
    <i class="fa-solid fa-print"></i>
    <i class="fa-solid fa-cloud"></i>
    <img id="profile-icon" class="profile-img"
         src="https://images.unsplash.com/photo-1600353068440-6361ef3a86e8?auto=format&fit=crop&w=1000&q=80"
         alt="Perfil">
  </div>

  <!-- Dropdown criado dinamicamente -->
  <div id="moreMenu" class="more-menu"></div>
</div>



    <div class="wrapper">
      <!-- Menu lateral -->
      <div class="left-side">
<div class="side-wrapper">
  <div class="side-title"
       data-nav-key="side:produtos"
       data-nav-pos="side"
       data-nav-label="Produtos">Produtos</div>

  <div class="side-menu">
    <a href="#"
       id="btn-omie-list1"
       data-nav-key="side:produtos:lista"
       data-nav-parent="side:produtos"
       data-nav-pos="side"
       data-nav-label="Lista de produtos"
       data-nav-selector="#btn-omie-list1">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right:8px;flex-shrink:0;">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
      Lista de produtos
    </a>

    <a href="#"
       id="btn-omie-list"
       data-nav-key="side:produtos:constr2"
       data-nav-parent="side:produtos"
       data-nav-pos="side"
       data-nav-label="em construção 2"
       data-nav-selector="#btn-omie-list">
      <svg viewBox="0 0 512 512"></svg>
      em construção 2
    </a>

    <a href="#"
       data-nav-key="side:produtos:constr3"
       data-nav-parent="side:produtos"
       data-nav-pos="side"
       data-nav-label="em construção 3">
      <svg viewBox="0 0 488.932 488.932" fill="currentColor"></svg>
      em construção 3
      <span class="notification-number updates">3</span>
    </a>
  </div>
</div>

<div class="side-wrapper">
  <div class="side-title"
       data-nav-key="side:rh"
       data-nav-pos="side"
       data-nav-label="Recursos humanos">Recursos humanos</div>

  <div class="side-menu">

    <a href="#"
       id="btn-colaboradores"
       class="side-menu-item"
       data-colab="colab"
       data-nav="colaboradores"
       data-nav-key="side:rh:cad-colab"
       data-nav-parent="side:rh"
       data-nav-pos="side"
       data-nav-label="Cadastro de colaboradores"
       data-nav-selector="#btn-colaboradores">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right:8px; flex-shrink:0;">
        <path d="M12 12a5 5 0 100-10 5 5 0 000 10zm0 2c-4.42 0-8 1.79-8 4v2h16v-2c0-2.21-3.58-4-8-4z"/>
      </svg>
      Cadastro de colaboradores
    </a>

    <a href="#" class="menu-link"
       data-nav-key="side:rh:aniversariantes"
       data-nav-parent="side:rh"
       data-nav-pos="side"
       data-nav-label="Aniversariantes">Aniversariantes</a>

    <a href="#"
       data-nav-key="side:rh:constr18"
       data-nav-parent="side:rh"
       data-nav-pos="side"
       data-nav-label="… em construção 18 …">… em construção 18 …</a>
  </div>
</div>




<!-- Nova categoria: Logística -->
<div class="side-wrapper">
  <div class="side-title"
       data-nav-key="side:log"
       data-nav-pos="side"
       data-nav-label="Logística">Logística</div>

  <div class="side-menu">
    <a href="#"
       id="menu-pedidos"
       class="menu-link"
       data-nav-key="side:log:pedidos"
       data-nav-parent="side:log"
       data-nav-pos="side"
       data-nav-label="Pedidos"
       data-nav-selector="#menu-pedidos">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right:8px;">
        <path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/>
      </svg>
      Pedidos
    </a>

    <a href="#"
       id="menu-armazens"
       class="menu-link"
       data-nav-key="side:log:armazens"
       data-nav-parent="side:log"
       data-nav-pos="side"
       data-nav-label="Armazéns"
       data-nav-selector="#menu-armazens">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right:8px;">
        <path d="M3 9.5V21h3v-7h12v7h3V9.5L12 3 3 9.5zM9 19H6v-5h3v5zm9 0h-3v-5h3v5z"/>
      </svg>
      Armazéns
    </a>
  </div>
</div>



      </div>

      <!-- Conteúdo principal -->

      <!-- Painel Início — aparece primeiro -->
<div id="paginaInicio" class="tab-pane" style="display:block;">
  <div class="content-wrapper">
    <div class="content-section">

<div class="inicio-grid">
  <button class="inicio-btn"
          id="btn-linha-producao"
          data-nav-key="inicio:linha-producao"
          data-nav-pos="top"
          data-nav-label="Linha de produção"
          data-nav-selector="#btn-linha-producao">Linha de produção</button>

  <button id="btn-prep-eletrica" class="inicio-btn"
          data-nav-key="inicio:prep-eletrica"
          data-nav-pos="top"
          data-nav-label="Preparação elétrica"
          data-nav-selector="#btn-prep-eletrica">Preparação elétrica</button>

  <button class="inicio-btn"
          data-nav-key="inicio:prep-base"
          data-nav-pos="top"
          data-nav-label="Preparação da base">Preparação da base</button>


</div>



    </div>
  </div>
</div>

      <div class="main-container">

        <!-- Painel de Lista de Produtos -->
        <div id="listaProdutos" class="tab-pane" style="display:none;">
          <div class="content-wrapper">
            <div class="content-section">
              <div class="title-wrapper">
                <div class="content-section-title">
                  Lista de produtos (<span id="productCount">0</span>)
                </div>
                <div id="productSpinner" data-pct="0" style="display:none;">
                  <svg id="svg" viewBox="0 0 200 200" preserveAspectRatio="xMidYMid meet">
                    <circle r="90" cx="100" cy="100" fill="transparent"
                            stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
                    <circle id="bar" r="90" cx="100" cy="100" fill="transparent"
                            stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
                  </svg>
                </div>
              </div>
              <div class="filter-bar">
                <input type="text" id="codeFilter"  placeholder="Pesquisar código"/>
                <input type="text" id="descFilter"  placeholder="Pesquisar descrição"/>
                <button id="filterBtn" class="filter-icon">
                  <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="1.5" fill="none"
                       stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 4h18l-7 8v6l-4 2v-8l-7-8z"/>
                  </svg>
                </button>
              </div>
              <div id="filterPanel" class="filter-panel">
                <div class="filter-row">
                  <label for="familySelect">Família:</label>
                  <select id="familySelect"><option value="">– selecione –</option></select>
                  <label for="tipoItemSelect">Tipo de Item:</label>
                  <select id="tipoItemSelect"><option value="">– selecione –</option></select>
                </div>
                <div class="filter-row">
                  <label for="caracteristicaSelect">Característica:</label>
                  <select id="caracteristicaSelect"><option value="">– selecione –</option></select>
                  <label for="conteudoSelect" id="conteudoLabel" style="display:none">Conteúdo:</label>
                  <select id="conteudoSelect" style="display:none"><option value="">– selecione –</option></select>
                </div>
              </div>
              <ul id="listaProdutosList" class="content-list product-details"></ul>
              <div id="pagination" class="pagination-wrapper"></div>
            </div>
          </div>
        </div>

<div id="produtoTabs">

        <!-- Abas internas principais -->
<div class="main-header">
  <div class="header-menu">
    <a class="main-header-link is-active"
       href="#"
       data-target="dadosProduto"
       data-nav-key="produto:dados"
       data-nav-parent="top:produto"
       data-nav-pos="top"
       data-nav-label="Dados do produto"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-target="dadosProduto"]'>
       Dados do produto
    </a>

    <a class="main-header-link"
       href="#"
       data-target="estruturaProduto"
       data-nav-key="produto:estrutura"
       data-nav-parent="top:produto"
       data-nav-pos="top"
       data-nav-label="Estrutura do produto"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-target="estruturaProduto"]'>
       Estrutura de produto
    </a>

    <a class="main-header-link"
       href="#"
       data-target="listaPecasTab"
       data-nav-key="produto:estrutura:lista-pecas"
       data-nav-parent="produto:estrutura"
       data-nav-pos="top"
       data-nav-label="Lista de peças"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-target="listaPecasTab"]'>
       Lista de peças
    </a>

    <a class="main-header-link"
       href="#"
       data-target="listaCaracteristica"
       data-nav-key="produto:estrutura:caracteristica"
       data-nav-parent="produto:estrutura"
       data-nav-pos="top"
       data-nav-label="Características"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-target="listaCaracteristica"]'>
       Características
    </a>

    <a class="main-header-link"
       href="#"
       data-target="listaFotos"
       data-nav-key="produto:estrutura:fotos"
       data-nav-parent="produto:estrutura"
       data-nav-pos="top"
       data-nav-label="Fotos"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-target="listaFotos"]'>
       Fotos
    </a>
  </div>
</div>



        <div class="tab-content">

          <!-- Dados do produto -->
          <div id="dadosProduto" class="tab-pane" style="display:none;">
            <!-- 1) Cabeçalho com título, descrição e imagem -->
            <div class="content-wrapper">
              <div class="content-wrapper-header">
                <div class="content-wrapper-context">
                  <h3 class="img-content">
                    <svg viewBox="0 0 512 512"><!-- ícone --></svg>
                    <span id="productTitle">Código do produto</span>
                  </h3>
                  <div class="content-text" id="productDesc"></div>
                  <button class="content-button">Pedido de compra</button>
                </div>
                <img class="content-wrapper-img"
                     id="productImg"
                     src="../img/logo.png"
                     alt="Produto">
              </div>
            </div>

<!-- 2) Novo conjunto de abas dentro de Dados do produto -->
<div class="main-header sub-tabs" style="margin-top: 20px;">
  <div class="header-menu">

    <a class="main-header-link is-active" href="#" data-subtarget="detalhesTab"
       data-nav-key="produto:dados:detalhes"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="Detalhes do produto"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="detalhesTab"]'>
       Detalhes do produto
    </a>

    <a class="main-header-link" href="#" data-subtarget="cadastroTab"
       data-nav-key="produto:dados:cadastro"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="Dados de cadastro"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="cadastroTab"]'>
       Dados de cadastro
    </a>

    <a class="main-header-link" href="#" data-subtarget="financeiroTab"
       data-nav-key="produto:dados:financeiro"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="Financeiro"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="financeiroTab"]'>
       Financeiro
    </a>

    <a class="main-header-link" href="#" data-subtarget="logisticaTab"
       data-nav-key="produto:dados:logistica"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="Logística"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="logisticaTab"]'>
       Logística
    </a>

    <a href="#" class="main-header-link" data-subtarget="pdv"
       data-nav-key="produto:dados:pdv"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="PDV"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="pdv"]'>
       PDV
    </a>

    <a href="#" class="main-header-link" data-subtarget="compras"
       data-nav-key="produto:dados:compras"
       data-nav-parent="produto:dados"
       data-nav-pos="top"
       data-nav-label="Compras"
       data-nav-selector='#produtoTabs .main-header .main-header-link[data-subtarget="compras"]'>
       Compras
    </a>

  </div>
</div>


<!-- 3) Blocos de conteúdo secundário (um para cada aba) -->
<div class="sub-content" id="detalhesTab">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Detalhes do produto</div>
      <ul id="detalhesList" class="content-list product-details">
        <!-- Será preenchido via JS -->
      </ul>
    </div>
  </div>
</div>

<div class="sub-content" id="cadastroTab" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Dados de cadastro</div>
      <ul id="cadastroList" class="content-list product-details">
        <!-- Será preenchido via JS -->
      </ul>
    </div>
  </div>
</div>

<div class="sub-content" id="financeiroTab" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Financeiro</div>
      <ul id="financeiroList" class="content-list product-details">
        <!-- Será preenchido via JS -->
      </ul>
    </div>
  </div>
</div>



<div class="sub-content" id="logisticaTab" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Logística</div>
      <ul id="logisticaList" class="content-list product-details">
        <!-- Será preenchido via JS -->
      </ul>
    </div>
  </div>
</div>

<!-- Aba PDV -->
<div id="pdv" class="sub-content" style="display:none">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">PDV</div>
      <ul id="pdvList" class="content-list product-details">
        <!-- Preenchido por JS -->
      </ul>
    </div>
  </div>
</div>

<!-- Aba Compras -->
<div id="compras" class="sub-content" style="display:none">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Compras</div>
      <ul id="comprasList" class="content-list product-details">
        <!-- Preenchido por JS -->
      </ul>
    </div>
  </div>
</div>


          </div>

          <!-- Estrutura do produto -->
          <div id="estruturaProduto" class="tab-pane" style="display:none;">
            <div class="content-wrapper">
              <div class="content-section">
                <div class="title-wrapper">
                  <div class="content-section-title">Estrutura de produto</div>
                  <!-- Spinner + texto -->
                  <div id="estoqueSpinnerBox" class="spinner-box" style="display:none;">
                    <div id="estoqueSpinner" data-pct="0">
                      <svg id="svgEst" viewBox="0 0 200 200">
                        <circle r="90" cx="100" cy="100" fill="transparent"
                                stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
                        <circle id="barEst" r="90" cx="100" cy="100" fill="transparent"
                                stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
                      </svg>
                    </div>
                    <span class="spinner-label">Carregando custo real…</span>
                  </div>
                </div>
                <ul id="malha" class="content-list">
                  <li class="header-row">
                    <div>Código</div>
                    <div>Descrição</div>
                    <div>QTD</div>
                    <div>Unidade</div>
                    <div>Custo real</div>
                    <div>Editar</div>
                  </li>
                </ul>
              </div>
            </div>
          </div>

<!-- Lista de peças (aba) -->
<div id="listaPecasTab" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">

      <!-- wrapper necessário p/ botão de filtro -->
      <div class="title-wrapper">
        <div class="content-section-title">Lista de peças</div>
      </div>

      <!-- ul que o JS espera -->
      <ul id="listaPecasList" class="content-list">
        <!-- cabeçalho fixo: o script repõe/atualiza -->
        <li class="header-row">
          <div>Código</div>
          <div>Descrição</div>
          <div>QTD</div>
          <div>Unidade</div>
          <div>Valor&nbsp;sugerido</div>
          <div>Abrir</div>
        </li>
      </ul>

    </div>
  </div>
</div>

          
<!-- Características -->
<div id="listaCaracteristica" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="content-section-title">Características</div>

      <!-- botão provisorio-->
        <button class="content-button" data-action="incluir-conteudo" style="margin-left: 10px;">
    🛠️ Incluir conteúdo
        </button>
       <!-- botão provisorio-->

       
      <ul id="listacaracteristica" class="content-list product-details"></ul>
    </div>
  </div>
</div>


          <!-- Aba Fotos -->
          <div id="listaFotos" class="tab-pane" style="display:none;">
            <div class="content-wrapper">
              <h3 class="content-section-title">Fotos</h3>
              <div class="options"></div>
            </div>
          </div>
            
          <div id="acessos" class="tab-pane" style="display:none;">
            <div class="content-wrapper">
              <div class="content-section">
          
                <!-- 1) Título -->
                <div class="title-wrapper">
                  <div class="content-section-title">Gerenciar Acessos</div>
                </div>
          
                <!-- 2) Lista de usuários -->
                <div id="userList" class="content-list"></div>
          
                <!-- 3) Botão Novo Usuário -->
                <button id="btnNewUser" class="content-button">Novo Usuário</button>
          
                <!-- 4) Formulário oculto -->
                <div id="userForm" style="display:none; margin-top:1rem;">
                  <input id="inpUsername" placeholder="Usuário"/>
                  <button id="btnSaveUser" class="content-button">Criar Usuário</button>
                </div>
          
                <hr style="margin:2rem 0; border-color: var(--border-color)" />

                <div class="menu-scroll">
                  <!-- Categoria 1: Menu Lateral -->
                  <div class="title-wrapper">
                    <div class="content-section-title">Menu Lateral</div>
                  </div>
                  <ul id="sideMenuList" class="content-list">
                    <!-- …itens… -->
                  </ul>
                
                  <!-- Divisor interno entre categorias -->
                  <hr style="margin:1.5rem 0; border-color: var(--border-color)" />
                
                  <!-- Categoria 2: Menu Superior -->
                  <div class="title-wrapper">
                    <div class="content-section-title">Menu Superior</div>
                  </div>
                  <ul id="topMenuList" class="content-list">
                    <!-- …itens… -->
                  </ul>
                </div> <!-- /.menu-scroll -->
                
          
              </div> <!-- /.content-section -->
            </div> <!-- /.content-wrapper -->
          </div> <!-- /#acessos -->
          
<!-- Painel de notificações ------------------------------------------------>
<div id="notificacoes" class="tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="title-wrapper">
        <div class="content-section-title">Notificações</div>
      </div>

      <ul id="listaNotificacoes" class="content-list"></ul>
    </div>
  </div>
</div>

          
            



        </div> <!-- /.tab-content -->

</div> <!-- /#produtoTabs -->

<!-- Abas de Pedidos (inicialmente ocultas) -->
<div id="kanbanTabs" class="main-header" style="display:none; margin-top:1rem;">
  <div class="header-menu">
    <a href="#" data-kanban-tab="comercial" class="main-header-link is-active">Comercial</a>
    <a href="#" data-kanban-tab="pcp"       class="main-header-link">PCP</a>
<a href="#" data-kanban-tab="preparacao" class="main-header-link">
  Preparação
</a>

    <a href="#" data-kanban-tab="producao"  class="main-header-link">Produção</a>
    <a href="#" data-kanban-tab="detalhes"  class="main-header-link">Detalhes</a>
  </div>
</div>

<!-- Abas de Armazéns (inicialmente ocultas) -->
<div id="armazemTabs" class="main-header" style="display:none; margin-top:1rem;">
  <div class="header-menu">
    <a href="#" data-arm-tab="almoxarifado" class="main-header-link is-active">Almoxarifado</a>
    <a href="#" data-arm-tab="producao"      class="main-header-link">Produção</a>
    <a href="#" data-arm-tab="expedicao"     class="main-header-link">Expedição</a>
    <a href="#" data-arm-tab="produto"       class="main-header-link">Produto acabado</a>
    <a href="#" data-arm-tab="terceiros"     class="main-header-link">Terceiros</a>
    <a href="#" data-arm-tab="Geral"     class="main-header-link">geral</a>
  </div>
</div>

<div id="armazemContent" style="display:none;">
<!-- Painel de Almoxarifado (Armazéns) -->
<div id="conteudo-almoxarifado" class="armazem-page tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="title-wrapper">
        <div class="content-section-title">
          Almoxarifado (<span id="almoxCount">0</span>)
        </div>

        <input id="almoxSearch"
       type="text"
       placeholder="Pesquisar na descrição…"
       class="search-box" />

       <span id="almoxCmcTotal" class="cmc-total">Total CMC: R$ 0,00</span>
      
<button id="almoxFilterBtn" class="filter-icon" title="Filtrar por tipo">
  <i class="fa-solid fa-filter"></i>
</button>

<!-- Painel que aparece/ some -->
<div id="almoxFilterPanel" class="filter-panel" style="display:none;"></div>


        <!-- spinner opcional (mesmo padrão que você usa em Pedidos) -->
        <div id="almoxSpinner" data-pct="0" style="display:none;">
          <!-- copie seu SVG de spinner aqui se quiser -->
        </div>
      </div>

      <!-- aqui a tabela é montada em runtime -->
<!-- —— wrapper fixo + scroll —— -->
<div class="almox-wrapper">
  <table id="tbl-almoxarifado" class="tabela padrao">
    <thead>
      <tr>
        <th>Código</th><th>Descrição</th><th>Est. mín.</th>
        <th>Físico</th><th>Reservado</th><th>Saldo</th><th>CMC</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- —— paginação —— -->
<div class="almox-pager">
  <button id="almoxPrev"  class="btn tiny">◀</button>
  <span   id="almoxPageInfo">1 / 1</span>
  <button id="almoxNext"  class="btn tiny">▶</button>
</div>


    </div>
  </div>
</div>

<!-- Painel de Produção -->
<div id="conteudo-producao" class="armazem-page tab-pane" style="display:none;">
  <div class="content-wrapper">
    <div class="content-section">
      <div class="title-wrapper">
        <div class="content-section-title">
          Produção (<span id="prodCount">0</span>)
        </div>

        <input id="prodSearch"
               type="text"
               placeholder="Pesquisar na descrição…"
               class="search-box" />

        <span id="prodCmcTotal" class="cmc-total">Total CMC: R$ 0,00</span>
        <button id="prodFilterBtn" class="filter-icon" title="Filtrar por grupo">
  <i class="fa-solid fa-filter"></i>
</button>

<div id="prodFilterPanel" class="filter-panel" style="display:none;"></div>

      </div>

      <div class="producao-wrapper">
        <table id="tbl-producao" class="tabela padrao">
          <thead>
            <tr>
              <th>Código</th><th>Descrição</th><th>Est. mín.</th>
              <th>Físico</th><th>Reservado</th><th>Saldo</th><th>CMC</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="almox-pager"><!-- reaproveita classe -->
        <button id="prodPrev" class="btn tiny">◀</button>
        <span   id="prodPageInfo">1 / 1</span>
        <button id="prodNext" class="btn tiny">▶</button>
      </div>
    </div>
  </div>
</div>

  <div id="conteudo-expedicao"    class="armazem-page" style="display:none;"></div>
  <div id="conteudo-produto"      class="armazem-page" style="display:none;"></div>
  <div id="conteudo-terceiros"    class="armazem-page" style="display:none;"></div>
  <div id="conteudo-geral"    class="armazem-page" style="display:none;"></div>
</div>



  <!-- Comercial -->
<div id="kanbanContent" style="display:none;">
  <div id="conteudo-comercial" class="kanban-page">
<div class="kanban-board">
<div class="kanban-column">
  <div class="kanban-header">
    <div class="title-wrapper">
      <span>Pedido aprovado</span>
      <!-- Spinner escondido por CSS até ser exibido pelo JS -->
      <i class="fas fa-spinner fa-spin kanban-spinner"></i>
    </div>
  </div>
  <ul id="coluna-comercial" class="kanban-list"></ul>
</div>


<div class="kanban-column">
  <div class="kanban-header">
    <div class="title-wrapper">
      <span>Separação logística</span>
      <i class="fas fa-plus add-btn" title="Adicionar filtro"></i>
    </div>
    <div class="add-container">
      <input type="text" class="add-search" placeholder="Pesquisar…" />
      <!-- >>> Lista de resultados da busca <<< -->
      <ul class="add-results"></ul>
    </div>
  </div>
  <ul id="coluna-pcp-aprovado" class="kanban-list"></ul>
</div>



  <div class="kanban-column">
    <div class="kanban-header">Fila de produção</div>
    <ul id="coluna-pcp-op" class="kanban-list"></ul>
  </div>
</div>

    <div class="kanban-board">…</div>
  </div>


<div id="conteudo-pcp" class="kanban-page" style="display:none;">
  <div id="listaPecasPCP">
    <div class="content-wrapper">
      <div class="content-section">

        <!-- Barra: código do produto selecionado + multiplicador + OK + observação -->
<div id="pcp-code-bar" class="code-bar" style="display:none; margin:6px 0 12px;">
  <span id="pcp-code" class="prod-code"></span>
  <button id="pcp-open-search" class="plus-btn" title="Escolher outro produto">+</button>

  <input id="pcp-factor" class="qty-input" type="number" min="1" step="1" value="1" />
  <button id="pcp-ok" class="ok-btn">OK</button>

  <input id="pcp-obs" type="text" placeholder="Observações…" style="flex:1; min-width:220px;">
</div>

        <div class="title-wrapper" style="gap:12px; align-items:center;">
          <div class="content-section-title">Lista de peças</div>

          <!-- toolbar da lista (select do produto + filtro + spinner) -->
          <div style="display:flex; gap:8px; align-items:center; margin-left:auto;">
          </div>
        </div>



        <!-- Lista de peças (cabeçalho fixo + linhas dinâmicas) -->
<ul id="listaPecasPCPList" class="grid-pecas">
<li class="header-row">
  <div class="cod">Código</div>
  <div class="unid">Unid</div>
  <div class="qtd">Qtd</div>
  <div class="perda">% perda</div>
  <div class="qtdb">Qtd bruta</div>
  <div class="qtdpro">Qtd Pro</div>
  <div class="qtdalm">Qtd Alm</div>
  <!-- NOVO -->
  <div class="acao">Ação</div>
</li>

        </ul>
      </div>
    </div>
  </div>
</div>

<!-- ============================================================ -->

<!-- === bloco PREPARAÇÃO (Kanban) ============================ -->
<div id="conteudo-preparacao" class="kanban-page" style="display:none;">
  <div class="kanban-board">

    <!-- Coluna 1: A Produzir -->
    <div class="kanban-column">
      <div class="kanban-header">
        <div class="title-wrapper">
          <span>A Produzir</span>
          <i class="fas fa-plus add-btn" title="Adicionar filtro"></i>
        </div>
        <div class="add-container">
          <input type="text" class="add-search" placeholder="Pesquisar…" />
          <ul class="add-results"></ul>
        </div>
      </div>
      <ul id="coluna-prep-fila" class="kanban-list"></ul>
    </div>

    <!-- Coluna 2: Produzindo -->
    <div class="kanban-column">
      <div class="kanban-header"><span>Produzindo</span></div>
      <ul id="coluna-prep-em-producao" class="kanban-list"></ul>
    </div>

    <!-- Coluna 3: teste 1
    <div class="kanban-column">
      <div class="kanban-header"><span>teste 1</span></div>
      <ul id="coluna-prep-estoque" class="kanban-list"></ul>
    </div>

    <div class="kanban-column">
      <div class="kanban-header"><span>teste final</span></div>
      <ul id="coluna-prep-teste-final" class="kanban-list"></ul>
    </div> -->

    <!-- Coluna 5: concluido -->
    <div class="kanban-column">
      <div class="kanban-header"><span>concluido</span></div>
      <ul id="coluna-prep-concluido" class="kanban-list"></ul>
    </div>

  </div>
</div>
<!-- ========================================================= -->





  <div id="conteudo-producao" class="kanban-page" style="display:none;"></div>
  <div id="conteudo-detalhes" class="kanban-page" style="display:none;">
  <div id="detalhesContainer" class="detalhes-container">
    <!-- Detalhes do pedido serão inseridos aqui -->
  </div>
</div>

</div>








      </div> <!-- /.main-container -->





    </div> <!-- /.wrapper -->

    <div class="overlay-app" id="authOverlay"></div>
  </div> <!-- /.app -->



<!-- Modal de etiquetas ----------------------------->
<div id="etiquetasModal" class="modal">
  <div class="modal-content">
    <span class="close-modal">&times;</span>
    <h3>Etiquetas disponíveis</h3>
    <ul id="listaEtiquetas" class="etiquetas-list"></ul>
  </div>
</div>



 <!-- PapaParse 5.3.2 com hash corrigido -->
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"
  integrity="sha512-SGWgwwRA8xZgEoKiex3UubkSkV1zSE1BS6O4pXcaxcNtUlQsOmOmhVnDwIvqGRfEmuz83tIGL13cXMZn6upPyg=="
  crossorigin="anonymous"
  referrerpolicy="no-referrer">
</script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="module" src="login/login.js"></script>
  <script type="module" src="menu_produto.js"></script>
  
  <script type="module" src="./requisicoes_omie/filtro_produto.js"></script>
  <script type="module" src="./requisicoes_omie/ListarProdutos.js"></script>
  <script type="module" src="./requisicoes_omie/Dados_produto.js" defer></script>
  <script type="module" src="./requisicoes_omie/dados_colaboradores.js"></script>
  <script src="produtos/produto_foto.js" defer></script>
  <script type="module" src="produtos/Enviar_estrutura.js" defer></script>
  <script type="module" src="kanban/kanban_preparacao.js"></script>

  <script type="module" src="./kanban/kanban.js" defer></script>

<style>
  .mp-header{
    display:flex; align-items:center; justify-content:space-between;
    margin:12px 0 8px; padding:0 4px; color:#e5e7eb;
  }
  .mp-header .mp-title{ font-size:1.25rem; font-weight:700; }
  .mp-header .mp-title .muted{ opacity:.7; font-weight:600; }
  .mp-header .mp-back{
    padding:8px 14px; border:0; border-radius:10px;
    background:#0ea5e9; color:#fff; cursor:pointer;
    box-shadow:0 6px 14px rgba(14,165,233,.25);
  }
  .mp-header .mp-back:hover{ filter:brightness(1.05); }

    .kanban-list.droptarget { outline: 2px dashed #60a5fa; outline-offset: 2px; }
  .kanban-card.dragging   { opacity: .6; }
</style>



<script>
/* ========= Menu Produto: Kanban Preparação → modo OPs + Header + Drag&Drop ========= */
(() => {
  // IDs das 3 colunas deste quadro (iguais ao seu HTML)
  const IDS = {
    fila: 'coluna-prep-fila',
    em:   'coluna-prep-em-producao',
    conc: 'coluna-prep-concluido'
  };

  // --- Localização do wrapper certo (3 colunas) e onde inserir o header ---
  function getBoardWrapper() {
    // o board que queremos é o dentro da guia "Preparação"
    const wrapper = document.querySelector('#conteudo-preparacao .kanban-board');
    return wrapper || null;
  }

  function ensureHeader() {
    const wrapper = getBoardWrapper();
    if (!wrapper) return;

    let hdr = document.getElementById('mp-ops-header');
    if (!hdr) {
      hdr = document.createElement('div');
      hdr.id = 'mp-ops-header';
      hdr.className = 'mp-header';
      hdr.style.display = 'none';
      hdr.innerHTML = `
        <div class="mp-title">
          <span class="muted">Produto — </span><span id="mp-ops-code"></span>
        </div>
        <button id="mp-ops-exit" class="mp-back">Voltar</button>
      `;
      // Insere o header ANTES do grid de colunas (fica entre as abas e os kanbans)
      wrapper.parentElement.insertBefore(hdr, wrapper);
      document.getElementById('mp-ops-exit').onclick = exitOpsMode;
    } else {
      // se por algum motivo estiver longe, realoca para antes do wrapper
      if (hdr.nextElementSibling !== wrapper) {
        hdr.remove();
        wrapper.parentElement.insertBefore(hdr, wrapper);
      }
    }
  }

  function showHeaderWithCode(codAlfa) {
    ensureHeader();
    const hdr  = document.getElementById('mp-ops-header');
    const code = document.getElementById('mp-ops-code');
    if (hdr && code) {
      code.textContent = codAlfa;
      hdr.style.display = 'flex';
    }
  }

  // --- Drag & Drop helpers ---
  function statusFromUlId(ulId) {
    if (ulId === IDS.fila) return 'A Produzir';
    if (ulId === IDS.em)   return 'Produzindo';
    if (ulId === IDS.conc) return 'concluido';
    return null;
  }

  async function moveOpAPI(op, novoStatus) {
    const resp = await fetch(`/api/preparacao/op/${encodeURIComponent(op)}/mover`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: novoStatus })
    });
    const j = await resp.json().catch(() => ({}));
    if (!resp.ok || j.ok === false) {
      throw new Error(j.error || `Falha ao mover OP para ${novoStatus}`);
    }
    return j;
  }

  function attachOpDrag(li) {
    li.setAttribute('draggable', 'true');
    li.addEventListener('dragstart', (ev) => {
      ev.dataTransfer.setData('application/json', JSON.stringify({ op: li.dataset.op || '' }));
      ev.dataTransfer.effectAllowed = 'move';
      li.classList.add('dragging');
    });
    li.addEventListener('dragend', () => li.classList.remove('dragging'));
  }


  // Encontra o <li> da OP atual no mini-kanban
function findOpLi(op) {
  // OPs são do tipo P101101 → seguro usar direto no seletor
  return document.querySelector(`li.kanban-card[data-op="${op}"]`);
}

// Liga/desliga o “estado carregando” no cartão da OP
function setOpLoading(op, on) {
  const li = findOpLi(op);
  if (!li) return;

  if (on) {
    if (!li.classList.contains('loading')) {
      li.classList.add('loading'); // já tem estilo no seu CSS
      // spinner (mesmo do Comercial)
      const spin = document.createElement('i');
      spin.className = 'fas fa-spinner fa-spin kanban-spinner';
      spin.dataset.role = 'op-spinner';
      // barra de progresso (já estilizada no seu CSS)
      const bar = document.createElement('div');
      bar.className = 'loading-bar';
      bar.dataset.role = 'op-loading-bar';
      const prog = document.createElement('div');
      prog.className = 'progress';
      bar.appendChild(prog);

      li.appendChild(spin);
      li.appendChild(bar);
    }
  } else {
    li.classList.remove('loading');
    li.querySelectorAll('[data-role="op-spinner"],[data-role="op-loading-bar"]').forEach(n => n.remove());
  }
}

function attachDropZone(ul) {
  if (!ul) return;

  ul.addEventListener('dragover', (ev) => {
    if (ev.dataTransfer.types.includes('application/json')) {
      ev.preventDefault();
      ev.dataTransfer.dropEffect = 'move';
      ul.classList.add('droptarget');
    }
  });

  ul.addEventListener('dragleave', () => ul.classList.remove('droptarget'));

  ul.addEventListener('drop', async (ev) => {
    ev.preventDefault();
    ul.classList.remove('droptarget');

    let data = {};
    try { data = JSON.parse(ev.dataTransfer.getData('application/json') || '{}'); } catch {}
    const op = (data.op || '').trim().toUpperCase();
    const novoStatus = statusFromUlId(ul.id);
    if (!op || !novoStatus) return;

    // 🔔 feedback visual no cartão enquanto processa
    setOpLoading(op, true);

    try {
      await moveOpAPI(op, novoStatus);

      // redesenha o mini-kanban (vai remover o <li> antigo)
      const alfa = (window.codigoSelecionado || '').trim();
      const cp   = (window.codigoSelecionadoCP || '').toString().trim() || null;
      if (alfa) await window.renderOpsBoard(alfa, cp);

      // atualiza painéis globais também
      try { await window.Preparacao?.refreshPreparacaoUI?.(); } catch {}
    } catch (e) {
      // erro: tira o loading do cartão que ficou no lugar
      setOpLoading(op, false);
      alert(e.message || e);
    } finally {
      // se o <li> antigo ainda existir (ex.: erro), garanta que saiu do loading
      setOpLoading(op, false);
    }
  });
}


  // --- Resolvedor CP→Alfa para filtrar corretamente por produto ---
  let renderToken = 0;
  async function buildCpToAlphaMap(buckets) {
    const all = [...(buckets.fila||[]), ...(buckets.em||[]), ...(buckets.conc||[])];
    const cps = [...new Set(all.map(c => String(c.produto_codigo ?? '').trim()).filter(s => /^\d+$/.test(s)))];
    if (!cps.length) return {};
    const qs = cps.map(cp => 'cp=' + encodeURIComponent(cp)).join('&');
    try {
      const r = await fetch('/api/produtos/codigos?' + qs);
      const j = await r.json();
      return j?.data || {};
    } catch { return {}; }
  }
  const alphaFromMap = (map, cp) => (map[cp]?.codigo || null);

  // =================== RENDER mini-kanban de OPs (para 1 produto) ===================
  async function renderOpsBoard(codigoAlfa, codigoNum) {
    const rid = ++renderToken;

    const ulFila = document.getElementById(IDS.fila);
    const ulEm   = document.getElementById(IDS.em);
    const ulConc = document.getElementById(IDS.conc);
    if (!ulFila || !ulEm || !ulConc) return;

    const resp = await fetch('/api/preparacao/listar', { cache: 'no-store' });
    const payload = await resp.json();
    const data   = payload?.data || {};
    const buckets = {
      fila: data['A Produzir'] || [],
      em:   data['Produzindo'] || [],
      conc: data['concluido']  || []
    };

    const cpMap   = await buildCpToAlphaMap(buckets);
    const codAlfa = String(codigoAlfa || '').trim();
    const codNum  = codigoNum ? String(codigoNum).trim() : null;

    const matchProd = (c) => {
      const cp   = String(c.produto_codigo ?? '').trim();
      const alfa = alphaFromMap(cpMap, cp) || cp; // fallback: cp
      if (codNum  && cp   === codNum)  return true;
      if (codAlfa && alfa === codAlfa) return true;
      return false;
    };

    const dedupeByOp = (arr) => {
      const seen = new Set();
      return arr.filter(c => {
        const k = String(c.op || '').trim();
        if (!k || seen.has(k)) return false;
        seen.add(k);
        return true;
      });
    };

    let listaFila   = dedupeByOp(buckets.fila.filter(matchProd));
    let listaEmProd = dedupeByOp(buckets.em.filter(matchProd));
    let listaConc   = dedupeByOp(buckets.conc.filter(matchProd));

    // prioridade: Em produção > A Produzir
    const emOps = new Set(listaEmProd.map(x => x.op));
    listaFila = listaFila.filter(x => !emOps.has(x.op));

    if (rid !== renderToken) return;

    const fragFila = document.createDocumentFragment();
    const fragEm   = document.createDocumentFragment();
    const fragConc = document.createDocumentFragment();

    const pushOp = (frag, op) => {
      const li = document.createElement('li');
      li.className = 'kanban-card';
      li.textContent = op || '—';
      li.dataset.op = op;        // marca como item de OP
      attachOpDrag(li);          // ativa arraste
      frag.appendChild(li);
    };

    if (!listaFila.length)  { const li = document.createElement('li'); li.className='empty'; li.textContent='—'; fragFila.appendChild(li); }
    else { for (const c of listaFila)   pushOp(fragFila, c.op); }

    if (!listaEmProd.length){ const li = document.createElement('li'); li.className='empty'; li.textContent='—'; fragEm.appendChild(li); }
    else { for (const c of listaEmProd) pushOp(fragEm, c.op); }

    if (!listaConc.length)  { const li = document.createElement('li'); li.className='empty'; li.textContent='—'; fragConc.appendChild(li); }
    else { for (const c of listaConc)   pushOp(fragConc, c.op); }

    if (rid !== renderToken) return;
    ulFila.replaceChildren(fragFila);
    ulEm.replaceChildren(fragEm);
    ulConc.replaceChildren(fragConc);

    // Header “Produto — … [Voltar]” logo acima do quadro
    showHeaderWithCode(codAlfa);

    // As 3 colunas passam a aceitar drop
    attachDropZone(ulFila);
    attachDropZone(ulEm);
    attachDropZone(ulConc);
  }

  // =================== Entrar/Sair do modo OPs ===================
  function enterOpsMode(codigoAlfa, codigoNum) {
    window.__mpOpsMode = true;
    window.codigoSelecionado   = codigoAlfa;
    window.codigoSelecionadoCP = codigoNum || '';
    ensureHeader();
    renderOpsBoard(codigoAlfa, codigoNum);
  }

  async function renderAggregateBoard() {
    // Deixa o renderer oficial desenhar o kanban por produtos, se existir:
    if (typeof window.carregarKanbanPreparacao === 'function') {
      await window.carregarKanbanPreparacao();
    } else if (typeof window.initPreparacaoKanban === 'function') {
      await window.initPreparacaoKanban(true);
    } else {
      // Fallback duro
      location.reload();
    }
    // Esconde header
    const hdr = document.getElementById('mp-ops-header');
    if (hdr) hdr.style.display = 'none';
  }

  async function exitOpsMode() {
    window.__mpOpsMode = false;
    await renderAggregateBoard(); // volta ao kanban por produtos nesta mesma guia
  }

  // =================== Clique no cartão de PRODUTO → entra no modo OPs ===================
  function installClickDelegation() {
    const wrapper = getBoardWrapper();
    if (!wrapper) return;

    wrapper.addEventListener('click', (ev) => {
      const li = ev.target.closest('li.kanban-card');
      if (!li) return;
      // se já é item de OP (tem data-op), não reentra
      if (li.dataset && li.dataset.op) return;

      const alfa = (li.dataset?.codigo || '').trim();
      if (!alfa) return; // precisa do código alfanumérico
      const cp   = (li.dataset?.cp || '').trim(); // se tiver, ajuda o matching
      enterOpsMode(alfa, cp || null);
    });

    // ESC para sair do modo OPs
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && window.__mpOpsMode) exitOpsMode();
    });
  }

  // Exporte as funções úteis se quiser chamá-las de outros scripts
  window.renderOpsBoard = renderOpsBoard;
  window.enterOpsMode   = enterOpsMode;
  window.exitOpsMode    = exitOpsMode;
  window.showHeaderWithCode = showHeaderWithCode;

  // Boot: garante header e clique
  ensureHeader();
  installClickDelegation();
})();
</script>


</body>
</html>