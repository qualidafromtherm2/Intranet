<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscar Ordem de Produ√ß√£o</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1b2a;
      --card: #0f2538;
      --accent: #20dfc2;
      --accent-2: #ffc857;
      --text: #e6edf5;
      --muted: #9fb3c8;
      --shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(120% 120% at 10% 10%, rgba(32, 223, 194, 0.15), transparent),
                  radial-gradient(120% 120% at 90% 20%, rgba(255, 200, 87, 0.12), transparent),
                  radial-gradient(120% 120% at 50% 80%, rgba(32, 223, 194, 0.12), transparent),
                  var(--bg);
      color: var(--text);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }
    .panel {
      width: min(900px, 100%);
      background: linear-gradient(135deg, rgba(15, 37, 56, 0.98), rgba(17, 41, 60, 0.92));
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 18px;
      padding: 28px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(4px);
    }
    header { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 20px; }
    header h1 { margin: 0; font-size: 26px; letter-spacing: -0.02em; }
    header span { color: var(--muted); font-size: 14px; }
    form { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    input {
      flex: 1;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 16px;
      outline: none;
      transition: border-color 0.2s, background 0.2s, transform 0.15s;
    }
    input:focus { border-color: var(--accent); background: rgba(255, 255, 255, 0.08); transform: translateY(-1px); }
    button {
      padding: 14px 20px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0a0d14;
      font-weight: 700;
      letter-spacing: 0.01em;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(32, 223, 194, 0.35);
      transition: transform 0.15s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 16px 36px rgba(32, 223, 194, 0.5); }
    button:active { transform: translateY(0); }
    .status { min-height: 22px; color: var(--muted); margin: 6px 2px 14px; font-size: 14px; }
    .error { color: #ff7b7b; }
    .result { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; align-items: start; }
    .card { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.06); border-radius: 14px; padding: 16px; }
    .card h3 { margin: 0 0 8px; font-size: 16px; color: var(--muted); letter-spacing: 0.01em; }
    .icon-button { display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.06); color: var(--text); cursor: pointer; transition: border-color 0.15s, background 0.15s, transform 0.1s; }
    .icon-button:hover { border-color: var(--accent); background: rgba(255,255,255,0.12); }
    .icon-button:active { transform: translateY(1px); }
    .icon-button[hidden] { display: none; }
    .result { position: relative; }
    .manual-fab { position: absolute; top: -10px; right: 0; z-index: 2; }
    .card strong { display: block; font-size: 18px; color: var(--text); }
    table { width: 100%; border-collapse: collapse; color: var(--text); }
    th, td { padding: 8px 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); text-align: left; font-size: 14px; }
    th { color: var(--muted); font-weight: 600; }
    tbody tr:last-child td { border-bottom: none; }
    .label-preview { display: flex; align-items: center; justify-content: center; background: #0a1826; border-radius: 12px; border: 1px dashed rgba(255, 255, 255, 0.12); padding: 12px; min-height: 340px; overflow: hidden; }
    .label-preview img { display: block; max-width: 100%; max-height: 100%; height: auto; transform-origin: center; filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.4)); transition: transform 0.2s ease; }
    .label-preview.etiqueta img { width: 65%; max-width: none; max-height: none; transform: rotate(-90deg) scale(1.12); }
    .label-preview.product-image { min-height: 260px; padding: 6px; background: #0b1a2a; }
    .label-preview.product-image img { max-width: 100%; max-height: 100%; width: auto; object-fit: contain; transition: transform 0.16s ease, transform-origin 0.1s ease; }
    .carousel { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; gap: 8px; }
    .carousel-nav-host { display: flex; justify-content: space-between; align-items: center; margin: 6px 0 4px; gap: 8px; }
    .carousel-nav { display: flex; justify-content: flex-end; align-items: center; gap: 8px; width: 100%; }
    .carousel-track { position: relative; width: 100%; height: 100%; min-height: 260px; }
    .carousel-slide { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s ease; pointer-events: none; }
    .carousel-slide.active { opacity: 1; pointer-events: auto; }
    .carousel-btn { position: static; transform: none; background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.2); color: var(--text); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0,0,0,0.25); }
    .carousel-btn:hover { background: rgba(32, 223, 194, 0.16); border-color: rgba(32, 223, 194, 0.4); }
    .carousel-dots { position: absolute; bottom: 10px; left: 0; right: 0; display: flex; gap: 6px; justify-content: center; }
    .carousel-dot { width: 10px; height: 10px; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.4); background: rgba(255, 255, 255, 0.12); cursor: pointer; padding: 0; }
    .carousel-dot.active { background: var(--accent); border-color: var(--accent); }
    .spinner { display: inline-flex; align-items: center; gap: 8px; color: var(--text); }
    .spinner::before {
      content: "";
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    pre {
      background: #0a1826;
      color: #d1e7ff;
      padding: 12px;
      border-radius: 10px;
      border: 1px dashed rgba(255, 255, 255, 0.12);
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.4;
    }
    @media (max-width: 600px) {
      header { flex-direction: column; align-items: flex-start; }
      button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <header>
      <div>
        <h1>Consulta de Ordem</h1>
        <span>Digite o n√∫mero de s√©rie/OP e visualize a etiqueta.</span>
      </div>
      <span id="ping" aria-live="polite">Servidor carregado</span>
    </header>

    <form id="search-form">
      <input id="numero-op" name="numero_op" placeholder="Ex: OPS2500010" autocomplete="off" required />
      <button type="submit">Pesquisar</button>
    </form>
    <div id="status" class="status"></div>

    <div id="result" class="result" hidden>
      <button type="button" class="icon-button manual-fab" id="manual-link-global" title="Abrir manual" hidden>üîó</button>
      <div class="card">
        <h3>C√≥digo Omie</h3>
        <strong id="codigo-omie">‚Äî</strong>
      </div>
      <div class="card">
        <h3>Produto</h3>
        <strong id="codigo-produto">‚Äî</strong>
      </div>
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Descri√ß√£o</h3>
        <strong id="descricao-produto">‚Äî</strong>
      </div>
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Composi√ß√£o (Omie)</h3>
        <div id="estrutura-table" class="status">Nenhum item encontrado.</div>
      </div>
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Etiqueta</h3>
        <div class="label-preview etiqueta" id="label-preview">Nenhum dado.</div>
        <div id="label-error" class="status" style="margin-top:8px;"></div>
      </div>
      <div class="card" style="grid-column: 1 / -1;">
        <h3>Imagem do produto (Omie)</h3>
        <div id="produto-nav" class="carousel-nav-host"></div>
        <div class="label-preview product-image" id="produto-imagem">Nenhuma imagem.</div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("search-form");
    const input = document.getElementById("numero-op");
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");
    const codigoEl = document.getElementById("codigo-produto");
    const codigoOmieEl = document.getElementById("codigo-omie");
    const descricaoEl = document.getElementById("descricao-produto");
    const estruturaTableEl = document.getElementById("estrutura-table");
    const labelPreviewEl = document.getElementById("label-preview");
    const labelErrorEl = document.getElementById("label-error");
    const produtoNavEl = document.getElementById("produto-nav");
    const produtoImagemEl = document.getElementById("produto-imagem");
    const manualLinkGlobalBtn = document.getElementById("manual-link-global");
    const produtoHoverScale = 1;
    let produtoImgTag = null;
    let produtoScale = 1;
    let produtoImagens = [];
    let produtoSlides = [];
    let produtoDots = [];
    let produtoCurrentIndex = 0;
    let manualLinksCache = [];

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      const numero = input.value.trim();
      if (!numero) return;

      resetResultView();
      setStatusSpinner("Buscando...");
      toggleResult(false);

      try {
        const resp = await fetch(`/api/op?numero_op=${encodeURIComponent(numero)}`);
        const data = await resp.json();

        if (!resp.ok) {
          throw new Error(data.error || "Erro ao buscar");
        }

        await renderResult(data);
        setStatus("Encontrado");
      } catch (err) {
        setStatus(err.message, true);
      }
    });

    function resetResultView() {
      codigoEl.textContent = "‚Äî";
      codigoOmieEl.textContent = "‚Äî";
      descricaoEl.textContent = "‚Äî";
      estruturaTableEl.textContent = "Nenhum item encontrado.";
      estruturaTableEl.classList.remove("error");
      labelPreviewEl.textContent = "Nenhum dado.";
      labelErrorEl.textContent = "";
      produtoNavEl && (produtoNavEl.innerHTML = "");
      produtoImagemEl.textContent = "Nenhuma imagem.";
      manualLinkGlobalBtn?.setAttribute("hidden", "true");
    }

    async function renderResult(data) {
      codigoEl.textContent = data.codigo_produto || "‚Äî";
      codigoOmieEl.textContent = data.codigo_omie || "‚Äî";
      descricaoEl.textContent = data.descricao || "‚Äî";
      labelErrorEl.textContent = "";

      renderEstrutura(data.estrutura_items || []);
      const imagensLista = Array.isArray(data.produto_imagens)
        ? data.produto_imagens.filter(Boolean)
        : [];

      if (!imagensLista.length && data.produto_imagem) {
        imagensLista.push(data.produto_imagem);
      }

      renderImagens(imagensLista);
      updateManualButtons(data.manual_links || []);

      if (data.label_preview) {
        const base64 = `data:image/png;base64,${data.label_preview}`;
        const croppedSrc = await cropWhitespace(base64);
        const img = new Image();
        img.src = croppedSrc;
        img.alt = "Preview da etiqueta";
        labelPreviewEl.innerHTML = "";
        labelPreviewEl.appendChild(img);
      } else {
        labelPreviewEl.textContent = "N√£o foi poss√≠vel gerar a imagem da etiqueta";
        if (data.label_error) {
          labelErrorEl.textContent = data.label_error;
          labelErrorEl.classList.add("error");
        }
      }

      toggleResult(true);
    }

    async function cropWhitespace(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const w = img.naturalWidth;
          const h = img.naturalHeight;
          const canvas = document.createElement("canvas");
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          const { data } = ctx.getImageData(0, 0, w, h);

          let minX = w, minY = h, maxX = 0, maxY = 0;
          let found = false;
          for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
              const idx = (y * w + x) * 4;
              const r = data[idx];
              const g = data[idx + 1];
              const b = data[idx + 2];
              const alpha = data[idx + 3];
              // consider non-white if any channel is below 245 and visible
              if (alpha > 0 && (r < 245 || g < 245 || b < 245)) {
                found = true;
                if (x < minX) minX = x;
                if (y < minY) minY = y;
                if (x > maxX) maxX = x;
                if (y > maxY) maxY = y;
              }
            }
          }

          if (!found) {
            return resolve(dataUrl);
          }

          const cropW = Math.max(1, maxX - minX + 1);
          const cropH = Math.max(1, maxY - minY + 1);
          const out = document.createElement("canvas");
          out.width = cropW;
          out.height = cropH;
          const outCtx = out.getContext("2d");
          outCtx.drawImage(canvas, minX, minY, cropW, cropH, 0, 0, cropW, cropH);
          resolve(out.toDataURL("image/png"));
        };
        img.onerror = () => resolve(dataUrl);
        img.src = dataUrl;
      });
    }

    function renderEstrutura(items) {
      if (!items.length) {
        estruturaTableEl.textContent = "Nenhum item encontrado.";
        estruturaTableEl.classList.remove("error");
        return;
      }

      const rows = items
        .map((item) => {
          const { cod_prod_malha, descr_prod_malha, quant_prod_malha, unid_prod_malha } = item;
          const qtdFmt = formatQtd(quant_prod_malha);
          return `
            <tr>
              <td>${escapeHtml(cod_prod_malha || "")}</td>
              <td>${escapeHtml(descr_prod_malha || "")}</td>
              <td>${escapeHtml(qtdFmt)}</td>
              <td>${escapeHtml(unid_prod_malha || "")}</td>
            </tr>
          `;
        })
        .join("\n");

      estruturaTableEl.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>C√≥d. malha</th>
              <th>Descri√ß√£o</th>
              <th>Qtd.</th>
              <th>Unid.</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    function escapeHtml(text) {
      return String(text)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function formatQtd(value) {
      const n = Number(value);
      if (Number.isNaN(n)) return value ?? "";
      return new Intl.NumberFormat("pt-BR", {
        minimumFractionDigits: 1,
        maximumFractionDigits: 2
      }).format(n);
    }

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.classList.toggle("error", isError);
    }

    function setStatusSpinner(message) {
      statusEl.classList.remove("error");
      statusEl.innerHTML = `<span class="spinner">${escapeHtml(message || "Carregando...")}</span>`;
    }

    function updateManualButtons(manualLinks) {
      manualLinksCache = Array.isArray(manualLinks) ? manualLinks : [];
      const link = manualLinksCache[0]?.url;
      const title = manualLinksCache[0]?.nome || "Manual";
      const hasLink = Boolean(link);
      if (!manualLinkGlobalBtn) return;
      manualLinkGlobalBtn.hidden = !hasLink;
      if (hasLink) {
        manualLinkGlobalBtn.dataset.url = link;
        manualLinkGlobalBtn.title = `Abrir ${title}`;
      } else {
        delete manualLinkGlobalBtn.dataset.url;
        manualLinkGlobalBtn.removeAttribute("title");
      }
    }

    function openManualLink(event) {
      const btn = event.currentTarget;
      const url = btn?.dataset?.url;
      if (url) {
        window.open(url, "_blank", "noopener");
      }
    }

    function toggleResult(show) {
      resultEl.hidden = !show;
    }

    function renderImagens(imagens) {
      produtoImagemEl.innerHTML = "";
      produtoImagemEl.style.minHeight = "";
      produtoImgTag = null;
      produtoScale = 1;
      produtoImagens = Array.isArray(imagens) ? imagens.filter(Boolean) : [];
      produtoSlides = [];
      produtoDots = [];
      produtoCurrentIndex = 0;

      if (!produtoImagens.length) {
        produtoImagemEl.textContent = "Nenhuma imagem.";
        return;
      }

      const carousel = document.createElement("div");
      carousel.className = "carousel";

      // Nav fica fora do container da imagem (produtoNavEl)
      if (produtoNavEl) {
        produtoNavEl.innerHTML = "";
      }

      const navBar = document.createElement("div");
      navBar.className = "carousel-nav";

      const prevBtn = document.createElement("button");
      prevBtn.type = "button";
      prevBtn.className = "carousel-btn prev";
      prevBtn.setAttribute("aria-label", "Imagem anterior");
      prevBtn.textContent = "‚Äπ";

      const nextBtn = document.createElement("button");
      nextBtn.type = "button";
      nextBtn.className = "carousel-btn next";
      nextBtn.setAttribute("aria-label", "Pr√≥xima imagem");
      nextBtn.textContent = "‚Ä∫";

      navBar.appendChild(prevBtn);
      navBar.appendChild(nextBtn);

      if (produtoNavEl) {
        produtoNavEl.appendChild(navBar);
      } else {
        // fallback: coloca dentro do carrossel se host n√£o existir
        carousel.appendChild(navBar);
      }

      const track = document.createElement("div");
      track.className = "carousel-track";
      carousel.appendChild(track);

      const dotsWrapper = document.createElement("div");
      dotsWrapper.className = "carousel-dots";
      carousel.appendChild(dotsWrapper);

      produtoImagens.forEach((src, idx) => {
        const slide = document.createElement("div");
        slide.className = "carousel-slide";

        const img = new Image();
        img.src = src;
        img.alt = `Imagem do produto ${idx + 1}`;
        img.decoding = "async";
        img.onload = () => {
          const rotation = img.naturalWidth > img.naturalHeight ? 90 : 0;
          img.dataset.rotation = rotation;
          const effectiveHeight = rotation ? img.naturalWidth : img.naturalHeight;
          const targetHeight = Math.min(Math.max(effectiveHeight, 320), 820);
          img.dataset.targetHeight = `${targetHeight}px`;
          if (idx === produtoCurrentIndex) {
            produtoImgTag = img;
            applyProdutoTransform();
          }
        };
        img.onerror = () => {
          img.alt = "Nao foi possivel carregar a imagem.";
        };

        img.addEventListener("click", () => {
          if (src) {
            window.open(src, "_blank", "noopener");
          }
        });

        slide.appendChild(img);
        track.appendChild(slide);
        produtoSlides.push(slide);

        const dot = document.createElement("button");
        dot.type = "button";
        dot.className = "carousel-dot";
        dot.setAttribute("aria-label", `Selecionar imagem ${idx + 1}`);
        dot.addEventListener("click", () => setActiveSlide(idx));
        dotsWrapper.appendChild(dot);
        produtoDots.push(dot);
      });

      produtoImagemEl.appendChild(carousel);

      if (produtoSlides.length <= 1) {
        if (navBar.parentElement) navBar.style.display = "none";
        dotsWrapper.hidden = true;
      }

      prevBtn.addEventListener("click", () => setActiveSlide(produtoCurrentIndex - 1));
      nextBtn.addEventListener("click", () => setActiveSlide(produtoCurrentIndex + 1));

      setActiveSlide(0);
    }

    function setActiveSlide(index) {
      if (!produtoSlides.length) return;
      const total = produtoSlides.length;
      produtoCurrentIndex = ((index % total) + total) % total;

      produtoSlides.forEach((slide, idx) => {
        slide.classList.toggle("active", idx === produtoCurrentIndex);
      });

      produtoDots.forEach((dot, idx) => {
        dot.classList.toggle("active", idx === produtoCurrentIndex);
      });

      const activeImg = produtoSlides[produtoCurrentIndex].querySelector("img");
      produtoImgTag = activeImg || null;
      produtoScale = 1;

      // container height fixa pelo CSS; n√£o alteramos aqui

      applyProdutoTransform();
    }

    function applyProdutoTransform() {
      if (!produtoImgTag) return;
      const rotation = Number(produtoImgTag.dataset.rotation || "0");
      produtoImgTag.style.transform = `rotate(${rotation}deg) scale(${produtoScale})`;
    }

    function handleProdutoMouseMove(event) {
      if (!produtoImgTag) return;
      const rect = produtoImagemEl.getBoundingClientRect();
      const x = ((event.clientX - rect.left) / rect.width) * 100;
      const y = ((event.clientY - rect.top) / rect.height) * 100;
      produtoImgTag.style.transformOrigin = `${x}% ${y}%`;
    }

    function setProdutoHoverState(active) {
      produtoScale = active ? produtoHoverScale : 1;
      applyProdutoTransform();
    }

    // Zoom desativado: eventos de hover removidos
    manualLinkGlobalBtn?.addEventListener("click", openManualLink);
  </script>
</body>
</html>
